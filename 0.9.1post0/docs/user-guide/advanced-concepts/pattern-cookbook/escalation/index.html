<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A programming framework for agentic AI"><meta name=author content="Chi Wang & Qingyun Wu"><link href=https://docs.ag2.ai/latest/docs/user-guide/advanced-concepts/pattern-cookbook/escalation/ rel=canonical><link href=../context_aware_routing/ rel=prev><link href=../feedback_loop/ rel=next><link rel=icon href=../../../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.12"><title>Escalation - AG2</title><link rel=stylesheet href=../../../../../assets/stylesheets/main.2afb09e1.min.css><link rel=stylesheet href=../../../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Inter";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../../../css/timeago.css><link rel=stylesheet href=../../../../../assets/_mkdocstrings.css><link rel=stylesheet href=../../../../../stylesheets/extra.ff0633.min.css><script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-2GN2KN2CE4"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-2GN2KN2CE4",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-2GN2KN2CE4",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><meta http-equiv=Cache-Control content="no-cache, no-store, must-revalidate"><meta property=og:type content=website><meta property=og:title content="AG2 - Escalation"><meta property=og:description content="A programming framework for agentic AI"><meta content=https://docs.ag2.ai/latest/docs/user-guide/advanced-concepts/pattern-cookbook/escalation/ property=og:url><meta property=og:image content=https://opengraph.githubassets.com/1671805243.560327/ag2ai/ag2><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><meta name=twitter:card content=summary_large_image><meta name=twitter:title content="AG2 - Escalation"><meta name=twitter:description content="A programming framework for agentic AI"><meta name=twitter:image content=https://opengraph.githubassets.com/1671805243.560327/ag2ai/ag2><link rel=icon href=https://docs.ag2.ai/latest/assets/img/favicon.svg type=image/x-icon><link rel=icon href=https://docs.ag2.ai/latest/assets/img/favicon-dark.svg type=image/x-icon media="(prefers-color-scheme: light)"><link rel=icon href=https://docs.ag2.ai/latest/assets/img/favicon.svg type=image/x-icon media="(prefers-color-scheme: dark)"><link href=../../../../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style><script src=../../../../../assets/javascripts/glightbox.min.js></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=custom data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#key-characteristics class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-color-scheme=default data-md-component=outdated hidden> <aside class="md-banner md-banner--warning"> <div class="md-banner__inner md-grid md-typeset"> You're not viewing the latest version. <a href=../../../../../..> <strong>Click here to go to latest.</strong> </a> </div> <script>var el=document.querySelector("[data-md-component=outdated]"),base=new URL("../../../../.."),outdated=__md_get("__outdated",sessionStorage,base);!0===outdated&&el&&(el.hidden=!1)</script> </aside> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../../.. title=AG2 class="md-header__button md-logo" aria-label=AG2 data-md-component=logo> <img src=../../../../../assets/img/logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> AG2 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Escalation </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=custom data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=custom data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/ag2ai/ag2 title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> ag2ai/ag2 </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../../quick-start/ class=md-tabs__link> Quick Start </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../../basic-concepts/installing-ag2/ class=md-tabs__link> User Guide </a> </li> <li class=md-tabs__item> <a href=../../../../api-reference/autogen/Agent/ class=md-tabs__link> API References </a> </li> <li class=md-tabs__item> <a href=../../../../contributor-guide/contributing/ class=md-tabs__link> Contributor Guide </a> </li> <li class=md-tabs__item> <a href=../../../../ecosystem/agentops/ class=md-tabs__link> Ecosystem </a> </li> <li class=md-tabs__item> <a href=../../../../use-cases/use-cases/customer-service/ class=md-tabs__link> Use Cases </a> </li> <li class=md-tabs__item> <a href=../../../../user-stories/2025-04-30-Cegid-Pulse-OS/cegid_pulse_os/ class=md-tabs__link> Community Insights </a> </li> <li class=md-tabs__item> <a href=../../../../blog/ class=md-tabs__link> Blog </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../../.. title=AG2 class="md-nav__button md-logo" aria-label=AG2 data-md-component=logo> <img src=../../../../../assets/img/logo.svg alt=logo> </a> AG2 </label> <div class=md-nav__source> <a href=https://github.com/ag2ai/ag2 title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> ag2ai/ag2 </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../quick-start/ class=md-nav__link> <span class=md-ellipsis> Quick Start </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> User Guide </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> User Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../basic-concepts/installing-ag2/ class=md-nav__link> <span class=md-ellipsis> Installing AG2 </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../basic-concepts/overview/ class=md-nav__link> <span class=md-ellipsis> Basic Concepts </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3 checked> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> <span class=md-ellipsis> Advanced Concepts </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=true> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Advanced Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../llm-configuration-deep-dive/ class=md-nav__link> <span class=md-ellipsis> LLM Configuration Deep Dive </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_2 checked> <label class=md-nav__link for=__nav_2_3_2 id=__nav_2_3_2_label tabindex=0> <span class=md-ellipsis> Agent Orchestration Deep Dive </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_3_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2_3_2> <span class="md-nav__icon md-icon"></span> Agent Orchestration Deep Dive </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../orchestration/orchestrations/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../orchestration/two-agent-chat/ class=md-nav__link> <span class=md-ellipsis> Two Agent Chat </span> </a> </li> <li class=md-nav__item> <a href=../../orchestration/sequential-chat/ class=md-nav__link> <span class=md-ellipsis> Sequential Chat </span> </a> </li> <li class=md-nav__item> <a href=../../orchestration/nested-chat/ class=md-nav__link> <span class=md-ellipsis> Nested Chat </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../orchestration/group-chat/introduction/ class=md-nav__link> <span class=md-ellipsis> Group Chats </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../orchestration/swarm/deprecation/ class=md-nav__link> <span class=md-ellipsis> Swarm </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../orchestration/ending-a-chat/ class=md-nav__link> <span class=md-ellipsis> Ending A Chat </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_2_8 checked> <label class=md-nav__link for=__nav_2_3_2_8 id=__nav_2_3_2_8_label tabindex=0> <span class=md-ellipsis> Pattern Cookbook </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_2_8_label aria-expanded=true> <label class=md-nav__title for=__nav_2_3_2_8> <span class="md-nav__icon md-icon"></span> Pattern Cookbook </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../overview/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../context_aware_routing/ class=md-nav__link> <span class=md-ellipsis> Context-Aware Routing </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Escalation </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Escalation </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#key-characteristics class=md-nav__link> <span class=md-ellipsis> Key Characteristics </span> </a> </li> <li class=md-nav__item> <a href=#information-flow class=md-nav__link> <span class=md-ellipsis> Information Flow </span> </a> </li> <li class=md-nav__item> <a href=#implementation class=md-nav__link> <span class=md-ellipsis> Implementation </span> </a> </li> <li class=md-nav__item> <a href=#agent-flow class=md-nav__link> <span class=md-ellipsis> Agent Flow </span> </a> </li> <li class=md-nav__item> <a href=#code class=md-nav__link> <span class=md-ellipsis> Code </span> </a> </li> <li class=md-nav__item> <a href=#output class=md-nav__link> <span class=md-ellipsis> Output </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../feedback_loop/ class=md-nav__link> <span class=md-ellipsis> Feedback Loop </span> </a> </li> <li class=md-nav__item> <a href=../hierarchical/ class=md-nav__link> <span class=md-ellipsis> Hierarchical </span> </a> </li> <li class=md-nav__item> <a href=../organic/ class=md-nav__link> <span class=md-ellipsis> Organic </span> </a> </li> <li class=md-nav__item> <a href=../pipeline/ class=md-nav__link> <span class=md-ellipsis> Pipeline / Sequential </span> </a> </li> <li class=md-nav__item> <a href=../redundant/ class=md-nav__link> <span class=md-ellipsis> Redundant </span> </a> </li> <li class=md-nav__item> <a href=../star/ class=md-nav__link> <span class=md-ellipsis> Star </span> </a> </li> <li class=md-nav__item> <a href=../triage_with_tasks/ class=md-nav__link> <span class=md-ellipsis> Triage with Tasks </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../tools/ class=md-nav__link> <span class=md-ellipsis> Tools </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../realtime-agent/ class=md-nav__link> <span class=md-ellipsis> RealtimeAgent </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../rag/ class=md-nav__link> <span class=md-ellipsis> RAG </span> </a> </li> <li class=md-nav__item> <a href=../../code-execution/ class=md-nav__link> <span class=md-ellipsis> Code Execution </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../models/amazon-bedrock/ class=md-nav__link> <span class=md-ellipsis> Model Providers </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../reference-agents/ class=md-nav__link> <span class=md-ellipsis> Reference Agents </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../reference-tools/ class=md-nav__link> <span class=md-ellipsis> Reference Tools </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../../../faq/FAQ/ class=md-nav__link> <span class=md-ellipsis> FAQ </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../api-reference/autogen/Agent/ class=md-nav__link> <span class=md-ellipsis> API References </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../contributor-guide/contributing/ class=md-nav__link> <span class=md-ellipsis> Contributor Guide </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../ecosystem/agentops/ class=md-nav__link> <span class=md-ellipsis> Ecosystem </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../use-cases/use-cases/customer-service/ class=md-nav__link> <span class=md-ellipsis> Use Cases </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../user-stories/2025-04-30-Cegid-Pulse-OS/cegid_pulse_os/ class=md-nav__link> <span class=md-ellipsis> Community Insights </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../blog/ class=md-nav__link> <span class=md-ellipsis> Blog </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#key-characteristics class=md-nav__link> <span class=md-ellipsis> Key Characteristics </span> </a> </li> <li class=md-nav__item> <a href=#information-flow class=md-nav__link> <span class=md-ellipsis> Information Flow </span> </a> </li> <li class=md-nav__item> <a href=#implementation class=md-nav__link> <span class=md-ellipsis> Implementation </span> </a> </li> <li class=md-nav__item> <a href=#agent-flow class=md-nav__link> <span class=md-ellipsis> Agent Flow </span> </a> </li> <li class=md-nav__item> <a href=#code class=md-nav__link> <span class=md-ellipsis> Code </span> </a> </li> <li class=md-nav__item> <a href=#output class=md-nav__link> <span class=md-ellipsis> Output </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/ag2ai/ag2/edit/main/website/docs/user-guide/advanced-concepts/pattern-cookbook/escalation.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m7 14.94 6.06-6.06 2.06 2.06L9.06 17H7zM12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m4.7-10.65-1 1-2.05-2.05 1-1c.21-.22.56-.22.77 0l1.28 1.28c.22.21.22.56 0 .77M12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2"/></svg> </a> <h1>Escalation</h1> <p>The Escalation Pattern is a resource-efficient approach to task handling where simpler, less resource-intensive agents handle tasks first, with more capable (but potentially more expensive) agents only being engaged when necessary.</p> <h3 id=key-characteristics>Key Characteristics<a class=headerlink href=#key-characteristics title="Permanent link">#</a></h3> <p><img alt="Escalation Pattern" src=../assets/escalation.jpeg></p> <p>The Escalation Pattern optimizes resource usage by intelligently routing tasks to appropriate agents based on complexity and agent capabilities. At its core, this pattern recognizes that not all queries require the same level of expertise or computational resources to address effectively. By establishing a hierarchy of agents with increasing capabilities and costs, the system can balance efficiency and quality.</p> <ul> <li> <p><strong>Progressive Capability</strong>: Tasks start with basic agents and escalate through progressively more capable agents only when needed.</p> </li> <li> <p><strong>Resource Efficiency</strong>: Simpler, less expensive agents handle straightforward tasks, while more powerful agents are reserved for complex problems.</p> </li> <li> <p><strong>Clear Escalation Criteria</strong>: Well-defined confidence thresholds and structured responses determine when to escalate to the next level.</p> </li> <li> <p><strong>Context Preservation</strong>: All context and query information is maintained throughout the escalation process.</p> </li> <li> <p><strong>Graceful Degradation</strong>: System handles varying complexity levels efficiently, providing the best available answer.</p> </li> </ul> <h3 id=information-flow>Information Flow<a class=headerlink href=#information-flow title="Permanent link">#</a></h3> <p><img alt="Escalation Flow" src=../assets/escalation_flow.jpeg></p> <p>The flow of information in the Escalation Pattern follows a deliberate path designed to maximize efficiency while ensuring that queries receive appropriate attention. Each query undergoes evaluation at multiple levels if necessary, with decisions made based on structured confidence assessments rather than subjective impressions. This systematic approach ensures consistent handling of queries and optimal resource allocation.</p> <ul> <li> <p><strong>Query Reception</strong>: The triage agent receives the user query and routes it to the basic agent.</p> </li> <li> <p><strong>Confidence Assessment</strong>: Each agent evaluates the query and provides a structured response with a confidence score.</p> </li> <li> <p><strong>Escalation Decision</strong>:</p> </li> <li>If confidence is below threshold (typically &lt; 8/10), escalate to the next agent level</li> <li> <p>If confidence is above threshold, return the response to the user</p> </li> <li> <p><strong>Context Tracking</strong>: Context variables track each agent's confidence score, escalation count, and reasons.</p> </li> <li> <p><strong>Result Delivery</strong>: The final answer is returned through the triage agent to the user.</p> </li> </ul> <h3 id=implementation>Implementation<a class=headerlink href=#implementation title="Permanent link">#</a></h3> <p>Implementing the Escalation Pattern requires careful design of both the agent architecture and the communication protocol between agents. The implementation leverages structured data formats and explicit confidence reporting to make escalation decisions transparent and consistent. By using the group chat orchestration engine, the pattern can be implemented with minimal custom code while maintaining robust escalation logic and context preservation.</p> <ul> <li> <p><strong>Structured Response Format</strong>: A Pydantic model (<code>ConsideredResponse</code>) captures answer, confidence, reasoning, and escalation information.</p> </li> <li> <p><strong>Confidence Thresholds</strong>: Agents escalate queries when their confidence falls below a defined threshold (8/10).</p> </li> <li> <p><strong>Agent-Specific Context Variables</strong>: Each agent's confidence and escalation decisions are tracked independently.</p> </li> <li> <p><strong>OnContextCondition</strong>: Transitions between agents are triggered by evaluating context variables.</p> </li> <li> <p><strong>Tool Functions</strong>: Specialized tool functions process structured responses and manage escalation logic.</p> </li> </ul> <h2 id=agent-flow>Agent Flow<a class=headerlink href=#agent-flow title="Permanent link">#</a></h2> <pre class=mermaid><code>sequenceDiagram
    participant User
    participant TriageAgent
    participant BasicAgent
    participant IntermediateAgent
    participant AdvancedAgent
    participant ToolExecutor

    User-&gt;&gt;TriageAgent: Complex RL question about&lt;br&gt;non-stationary bandits with HMM
    TriageAgent-&gt;&gt;ToolExecutor: new_question_asked()
    ToolExecutor-&gt;&gt;BasicAgent: Route complex question

    Note over BasicAgent: Assesses complexity&lt;br&gt;Confidence: 3/10&lt;br&gt;Needs escalation
    BasicAgent-&gt;&gt;ToolExecutor: answer_question_basic()

    Note over ToolExecutor: Checks confidence &lt; 8
    ToolExecutor-&gt;&gt;IntermediateAgent: Escalate question (low confidence)

    Note over IntermediateAgent: More knowledge but still&lt;br&gt;complex for capabilities&lt;br&gt;Confidence: 7/10&lt;br&gt;Needs escalation
    IntermediateAgent-&gt;&gt;ToolExecutor: answer_question_intermediate()

    Note over ToolExecutor: Checks confidence &lt; 8
    ToolExecutor-&gt;&gt;AdvancedAgent: Escalate question (specialized knowledge)

    Note over AdvancedAgent: Deep expertise in RL&lt;br&gt;Returns confidence: 9/10&lt;br&gt;Provides complete solution
    AdvancedAgent-&gt;&gt;ToolExecutor: answer_question_advanced()
    ToolExecutor-&gt;&gt;TriageAgent: Returns AdvancedAgent's answer
    TriageAgent-&gt;&gt;User: Complete mathematical model&lt;br&gt;for HMM-UCB algorithm

    User-&gt;&gt;TriageAgent: Simple math question:&lt;br&gt;"What is 100 divided by 5?"
    TriageAgent-&gt;&gt;ToolExecutor: new_question_asked()
    ToolExecutor-&gt;&gt;BasicAgent: Route simple question

    Note over BasicAgent: Simple arithmetic&lt;br&gt;Returns confidence: 10/10&lt;br&gt;No escalation needed
    BasicAgent-&gt;&gt;ToolExecutor: answer_question_basic()
    ToolExecutor-&gt;&gt;TriageAgent: Returns BasicAgent's answer
    TriageAgent-&gt;&gt;User: "100 divided by 5 is 20."

    Note over User: The escalation pattern efficiently routed&lt;br&gt;complex questions to advanced agents&lt;br&gt;while handling simple questions&lt;br&gt;with the most efficient agent</code></pre> <h2 id=code>Code<a class=headerlink href=#code title="Permanent link">#</a></h2> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>In this code example we use OpenAI's GPT-4o mini with structured outputs.</p> </div> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=c1># Example implementation of the Escalation Pattern for agent orchestration</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=c1># with structured confidence outputs and agent-specific context variables</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=kn>import</span><span class=w> </span><span class=nn>json</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Any</span><span class=p>,</span> <span class=n>Optional</span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=kn>from</span><span class=w> </span><span class=nn>pydantic</span><span class=w> </span><span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=kn>from</span><span class=w> </span><span class=nn>autogen</span><span class=w> </span><span class=kn>import</span> <span class=p>(</span>
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>    <span class=n>ConversableAgent</span><span class=p>,</span>
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>    <span class=n>UserProxyAgent</span><span class=p>,</span>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>    <span class=n>ContextExpression</span><span class=p>,</span>
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>    <span class=n>LLMConfig</span><span class=p>,</span>
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=p>)</span>
<a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=kn>from</span><span class=w> </span><span class=nn>autogen.agentchat</span><span class=w> </span><span class=kn>import</span> <span class=n>initiate_group_chat</span>
<a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=kn>from</span><span class=w> </span><span class=nn>autogen.agentchat.group</span><span class=w> </span><span class=kn>import</span> <span class=n>ReplyResult</span><span class=p>,</span> <span class=n>ContextVariables</span><span class=p>,</span> <span class=n>AgentNameTarget</span><span class=p>,</span> <span class=n>AgentTarget</span><span class=p>,</span> <span class=n>RevertToUserTarget</span><span class=p>,</span> <span class=n>OnContextCondition</span><span class=p>,</span> <span class=n>StayTarget</span><span class=p>,</span> <span class=n>ExpressionContextCondition</span><span class=p>,</span> <span class=n>TerminateTarget</span>
<a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=kn>from</span><span class=w> </span><span class=nn>autogen.agentchat.group.patterns</span><span class=w> </span><span class=kn>import</span> <span class=n>DefaultPattern</span>
<a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>
<a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a><span class=c1># Define structured output models</span>
<a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a><span class=k>class</span><span class=w> </span><span class=nc>ConsideredResponse</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
<a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Structured response format for agents in the escalation pattern&quot;&quot;&quot;</span>
<a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>    <span class=n>answer</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;The agent&#39;s answer to the query&quot;</span><span class=p>)</span>
<a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a>    <span class=n>confidence</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
<a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a>        <span class=o>...</span><span class=p>,</span>
<a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a>        <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Confidence level from 1-10 where 1 is extremely uncertain and 10 is absolutely certain&quot;</span><span class=p>,</span>
<a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a>    <span class=p>)</span>
<a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a>    <span class=n>reasoning</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;The agent&#39;s reasoning process&quot;</span><span class=p>)</span>
<a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a>    <span class=n>escalation_reason</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
<a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a>        <span class=kc>None</span><span class=p>,</span>
<a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a>        <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Reason for possible escalation if confidence &lt; 8.&quot;</span>
<a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a>    <span class=p>)</span>
<a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a>
<a id=__codelineno-0-31 name=__codelineno-0-31 href=#__codelineno-0-31></a>    <span class=k>class</span><span class=w> </span><span class=nc>Config</span><span class=p>:</span>
<a id=__codelineno-0-32 name=__codelineno-0-32 href=#__codelineno-0-32></a>        <span class=n>arbitrary_types_allowed</span> <span class=o>=</span> <span class=kc>True</span>
<a id=__codelineno-0-33 name=__codelineno-0-33 href=#__codelineno-0-33></a>
<a id=__codelineno-0-34 name=__codelineno-0-34 href=#__codelineno-0-34></a><span class=k>def</span><span class=w> </span><span class=nf>new_question_asked</span><span class=p>(</span><span class=n>question</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>context_variables</span><span class=p>:</span> <span class=n>ContextVariables</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ReplyResult</span><span class=p>:</span>
<a id=__codelineno-0-35 name=__codelineno-0-35 href=#__codelineno-0-35></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;If a new question is asked, this tool will reset context variables and route to the basic_agent. Only call this if the user has just asked a new question. If you have just received an answer, output it to the user.&quot;&quot;&quot;</span>
<a id=__codelineno-0-36 name=__codelineno-0-36 href=#__codelineno-0-36></a>    <span class=n>context_variables</span><span class=p>[</span><span class=s2>&quot;basic_agent_confidence&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
<a id=__codelineno-0-37 name=__codelineno-0-37 href=#__codelineno-0-37></a>    <span class=n>context_variables</span><span class=p>[</span><span class=s2>&quot;intermediate_agent_confidence&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
<a id=__codelineno-0-38 name=__codelineno-0-38 href=#__codelineno-0-38></a>    <span class=n>context_variables</span><span class=p>[</span><span class=s2>&quot;advanced_agent_confidence&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
<a id=__codelineno-0-39 name=__codelineno-0-39 href=#__codelineno-0-39></a>    <span class=n>context_variables</span><span class=p>[</span><span class=s2>&quot;escalation_count&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
<a id=__codelineno-0-40 name=__codelineno-0-40 href=#__codelineno-0-40></a>    <span class=n>context_variables</span><span class=p>[</span><span class=s2>&quot;last_escalation_reason&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span>
<a id=__codelineno-0-41 name=__codelineno-0-41 href=#__codelineno-0-41></a>    <span class=n>context_variables</span><span class=p>[</span><span class=s2>&quot;last_escalating_agent&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span>
<a id=__codelineno-0-42 name=__codelineno-0-42 href=#__codelineno-0-42></a>
<a id=__codelineno-0-43 name=__codelineno-0-43 href=#__codelineno-0-43></a>    <span class=n>context_variables</span><span class=p>[</span><span class=s2>&quot;current_question&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>question</span>
<a id=__codelineno-0-44 name=__codelineno-0-44 href=#__codelineno-0-44></a>    <span class=k>return</span> <span class=n>ReplyResult</span><span class=p>(</span>
<a id=__codelineno-0-45 name=__codelineno-0-45 href=#__codelineno-0-45></a>        <span class=n>target</span><span class=o>=</span><span class=n>AgentNameTarget</span><span class=p>(</span><span class=s2>&quot;basic_agent&quot;</span><span class=p>),</span>
<a id=__codelineno-0-46 name=__codelineno-0-46 href=#__codelineno-0-46></a>        <span class=n>context_variables</span><span class=o>=</span><span class=n>context_variables</span><span class=p>,</span>
<a id=__codelineno-0-47 name=__codelineno-0-47 href=#__codelineno-0-47></a>        <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;New question received, context variables reset.</span><span class=se>\n\n</span><span class=s2>basic_agent try and answer this question:</span><span class=se>\n</span><span class=si>{</span><span class=n>question</span><span class=si>}</span><span class=s2>&quot;</span>
<a id=__codelineno-0-48 name=__codelineno-0-48 href=#__codelineno-0-48></a>    <span class=p>)</span>
<a id=__codelineno-0-49 name=__codelineno-0-49 href=#__codelineno-0-49></a>
<a id=__codelineno-0-50 name=__codelineno-0-50 href=#__codelineno-0-50></a><span class=k>def</span><span class=w> </span><span class=nf>answer_question_common</span><span class=p>(</span><span class=n>response</span><span class=p>:</span> <span class=n>ConsideredResponse</span><span class=p>,</span> <span class=n>agent_level</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>context_variables</span><span class=p>:</span> <span class=n>ContextVariables</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ReplyResult</span><span class=p>:</span>
<a id=__codelineno-0-51 name=__codelineno-0-51 href=#__codelineno-0-51></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Common question answer function that updates context variables and routes based on the answer confidence.</span>
<a id=__codelineno-0-52 name=__codelineno-0-52 href=#__codelineno-0-52></a>
<a id=__codelineno-0-53 name=__codelineno-0-53 href=#__codelineno-0-53></a><span class=sd>    agent_level will be one of &quot;basic&quot;, &quot;intermediate&quot;, or &quot;advanced&quot;.</span>
<a id=__codelineno-0-54 name=__codelineno-0-54 href=#__codelineno-0-54></a><span class=sd>    &quot;&quot;&quot;</span>
<a id=__codelineno-0-55 name=__codelineno-0-55 href=#__codelineno-0-55></a>    <span class=n>context_variables</span><span class=p>[</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>agent_level</span><span class=si>}</span><span class=s2>_agent_confidence&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>confidence</span>
<a id=__codelineno-0-56 name=__codelineno-0-56 href=#__codelineno-0-56></a>
<a id=__codelineno-0-57 name=__codelineno-0-57 href=#__codelineno-0-57></a>    <span class=k>if</span> <span class=n>response</span><span class=o>.</span><span class=n>confidence</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>:</span>
<a id=__codelineno-0-58 name=__codelineno-0-58 href=#__codelineno-0-58></a>        <span class=n>context_variables</span><span class=p>[</span><span class=s2>&quot;escalation_count&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>context_variables</span><span class=p>[</span><span class=s2>&quot;escalation_count&quot;</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span>
<a id=__codelineno-0-59 name=__codelineno-0-59 href=#__codelineno-0-59></a>        <span class=n>context_variables</span><span class=p>[</span><span class=s2>&quot;last_escalation_reason&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>escalation_reason</span>
<a id=__codelineno-0-60 name=__codelineno-0-60 href=#__codelineno-0-60></a>        <span class=n>context_variables</span><span class=p>[</span><span class=s2>&quot;last_escalating_agent&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>agent_level</span><span class=si>}</span><span class=s2>_agent&quot;</span>
<a id=__codelineno-0-61 name=__codelineno-0-61 href=#__codelineno-0-61></a>
<a id=__codelineno-0-62 name=__codelineno-0-62 href=#__codelineno-0-62></a>        <span class=k>if</span> <span class=n>agent_level</span> <span class=o>==</span> <span class=s2>&quot;advanced&quot;</span><span class=p>:</span>
<a id=__codelineno-0-63 name=__codelineno-0-63 href=#__codelineno-0-63></a>            <span class=k>return</span> <span class=n>ReplyResult</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>AgentNameTarget</span><span class=p>(</span><span class=s2>&quot;triage_agent&quot;</span><span class=p>),</span> <span class=n>context_variables</span><span class=o>=</span><span class=n>context_variables</span><span class=p>,</span> <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;I am not confident with my answer (confidence level </span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>confidence</span><span class=si>}</span><span class=s2>/10, reason:</span><span class=se>\n</span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>escalation_reason</span><span class=si>}</span><span class=se>\n\n</span><span class=s2>answer: </span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>answer</span><span class=si>}</span><span class=se>\n\n</span><span class=s2>Please consult a human expert.&quot;</span><span class=p>)</span>
<a id=__codelineno-0-64 name=__codelineno-0-64 href=#__codelineno-0-64></a>
<a id=__codelineno-0-65 name=__codelineno-0-65 href=#__codelineno-0-65></a>        <span class=n>next_agent_level</span> <span class=o>=</span> <span class=s2>&quot;intermediate&quot;</span> <span class=k>if</span> <span class=n>agent_level</span> <span class=o>==</span> <span class=s2>&quot;basic&quot;</span> <span class=k>else</span> <span class=s2>&quot;advanced&quot;</span>
<a id=__codelineno-0-66 name=__codelineno-0-66 href=#__codelineno-0-66></a>        <span class=k>return</span> <span class=n>ReplyResult</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>AgentNameTarget</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>next_agent_level</span><span class=si>}</span><span class=s2>_agent&quot;</span><span class=p>),</span> <span class=n>context_variables</span><span class=o>=</span><span class=n>context_variables</span><span class=p>,</span> <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;Need to escalate with confidence </span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>confidence</span><span class=si>}</span><span class=s2>/10, reason:</span><span class=se>\n</span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>escalation_reason</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-0-67 name=__codelineno-0-67 href=#__codelineno-0-67></a>    <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-0-68 name=__codelineno-0-68 href=#__codelineno-0-68></a>        <span class=k>return</span> <span class=n>ReplyResult</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>AgentNameTarget</span><span class=p>(</span><span class=s2>&quot;triage_agent&quot;</span><span class=p>),</span> <span class=n>context_variables</span><span class=o>=</span><span class=n>context_variables</span><span class=p>,</span> <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;Successfully answered with confidence (</span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>confidence</span><span class=si>}</span><span class=s2>/10):</span><span class=se>\n</span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>answer</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-0-69 name=__codelineno-0-69 href=#__codelineno-0-69></a>
<a id=__codelineno-0-70 name=__codelineno-0-70 href=#__codelineno-0-70></a><span class=k>def</span><span class=w> </span><span class=nf>answer_question_basic</span><span class=p>(</span><span class=n>response</span><span class=p>:</span> <span class=n>ConsideredResponse</span><span class=p>,</span> <span class=n>context_variables</span><span class=p>:</span> <span class=n>ContextVariables</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ReplyResult</span><span class=p>:</span>
<a id=__codelineno-0-71 name=__codelineno-0-71 href=#__codelineno-0-71></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Always call this tool with your answer.&quot;&quot;&quot;</span>
<a id=__codelineno-0-72 name=__codelineno-0-72 href=#__codelineno-0-72></a>    <span class=k>return</span> <span class=n>answer_question_common</span><span class=p>(</span><span class=n>response</span><span class=p>,</span> <span class=s2>&quot;basic&quot;</span><span class=p>,</span> <span class=n>context_variables</span><span class=p>)</span>
<a id=__codelineno-0-73 name=__codelineno-0-73 href=#__codelineno-0-73></a>
<a id=__codelineno-0-74 name=__codelineno-0-74 href=#__codelineno-0-74></a><span class=k>def</span><span class=w> </span><span class=nf>answer_question_intermediate</span><span class=p>(</span><span class=n>response</span><span class=p>:</span> <span class=n>ConsideredResponse</span><span class=p>,</span> <span class=n>context_variables</span><span class=p>:</span> <span class=n>ContextVariables</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ReplyResult</span><span class=p>:</span>
<a id=__codelineno-0-75 name=__codelineno-0-75 href=#__codelineno-0-75></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Always call this tool with your answer.&quot;&quot;&quot;</span>
<a id=__codelineno-0-76 name=__codelineno-0-76 href=#__codelineno-0-76></a>    <span class=k>return</span> <span class=n>answer_question_common</span><span class=p>(</span><span class=n>response</span><span class=p>,</span> <span class=s2>&quot;intermediate&quot;</span><span class=p>,</span> <span class=n>context_variables</span><span class=p>)</span>
<a id=__codelineno-0-77 name=__codelineno-0-77 href=#__codelineno-0-77></a>
<a id=__codelineno-0-78 name=__codelineno-0-78 href=#__codelineno-0-78></a><span class=k>def</span><span class=w> </span><span class=nf>answer_question_advanced</span><span class=p>(</span><span class=n>response</span><span class=p>:</span> <span class=n>ConsideredResponse</span><span class=p>,</span> <span class=n>context_variables</span><span class=p>:</span> <span class=n>ContextVariables</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ReplyResult</span><span class=p>:</span>
<a id=__codelineno-0-79 name=__codelineno-0-79 href=#__codelineno-0-79></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Always call this tool with your answer.&quot;&quot;&quot;</span>
<a id=__codelineno-0-80 name=__codelineno-0-80 href=#__codelineno-0-80></a>    <span class=k>return</span> <span class=n>answer_question_common</span><span class=p>(</span><span class=n>response</span><span class=p>,</span> <span class=s2>&quot;advanced&quot;</span><span class=p>,</span> <span class=n>context_variables</span><span class=p>)</span>
<a id=__codelineno-0-81 name=__codelineno-0-81 href=#__codelineno-0-81></a>
<a id=__codelineno-0-82 name=__codelineno-0-82 href=#__codelineno-0-82></a><span class=k>def</span><span class=w> </span><span class=nf>main</span><span class=p>():</span>
<a id=__codelineno-0-83 name=__codelineno-0-83 href=#__codelineno-0-83></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<a id=__codelineno-0-84 name=__codelineno-0-84 href=#__codelineno-0-84></a><span class=sd>    Main function to demonstrate the Escalation Pattern with the Group Chat orchestration engine.</span>
<a id=__codelineno-0-85 name=__codelineno-0-85 href=#__codelineno-0-85></a><span class=sd>    &quot;&quot;&quot;</span>
<a id=__codelineno-0-86 name=__codelineno-0-86 href=#__codelineno-0-86></a>    <span class=c1># Triage agent will handle the user interaction</span>
<a id=__codelineno-0-87 name=__codelineno-0-87 href=#__codelineno-0-87></a>    <span class=n>triage_agent</span> <span class=o>=</span> <span class=n>ConversableAgent</span><span class=p>(</span>
<a id=__codelineno-0-88 name=__codelineno-0-88 href=#__codelineno-0-88></a>        <span class=n>name</span><span class=o>=</span><span class=s2>&quot;triage_agent&quot;</span><span class=p>,</span>
<a id=__codelineno-0-89 name=__codelineno-0-89 href=#__codelineno-0-89></a>        <span class=n>system_message</span><span class=o>=</span><span class=s2>&quot;&quot;&quot;You are a triage agent that routes queries to the appropriate level of expertise.</span>
<a id=__codelineno-0-90 name=__codelineno-0-90 href=#__codelineno-0-90></a><span class=s2>        If there&#39;s a new question, call the new_question_asked tool to process it.</span>
<a id=__codelineno-0-91 name=__codelineno-0-91 href=#__codelineno-0-91></a><span class=s2>        If a question has been successfully answered, output the question and answer and don&#39;t call a tool.</span>
<a id=__codelineno-0-92 name=__codelineno-0-92 href=#__codelineno-0-92></a><span class=s2>        You should never answer the question yourself.</span>
<a id=__codelineno-0-93 name=__codelineno-0-93 href=#__codelineno-0-93></a><span class=s2>        &quot;&quot;&quot;</span><span class=p>,</span>
<a id=__codelineno-0-94 name=__codelineno-0-94 href=#__codelineno-0-94></a>        <span class=n>functions</span><span class=o>=</span><span class=p>[</span><span class=n>new_question_asked</span><span class=p>],</span>
<a id=__codelineno-0-95 name=__codelineno-0-95 href=#__codelineno-0-95></a>        <span class=n>llm_config</span><span class=o>=</span><span class=n>LLMConfig</span><span class=p>(</span>
<a id=__codelineno-0-96 name=__codelineno-0-96 href=#__codelineno-0-96></a>            <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-4.1-mini&quot;</span><span class=p>,</span>
<a id=__codelineno-0-97 name=__codelineno-0-97 href=#__codelineno-0-97></a>            <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
<a id=__codelineno-0-98 name=__codelineno-0-98 href=#__codelineno-0-98></a>            <span class=n>cache_seed</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
<a id=__codelineno-0-99 name=__codelineno-0-99 href=#__codelineno-0-99></a>        <span class=p>)</span>
<a id=__codelineno-0-100 name=__codelineno-0-100 href=#__codelineno-0-100></a>    <span class=p>)</span>
<a id=__codelineno-0-101 name=__codelineno-0-101 href=#__codelineno-0-101></a>
<a id=__codelineno-0-102 name=__codelineno-0-102 href=#__codelineno-0-102></a>    <span class=c1># Create agents of increasing capability/cost</span>
<a id=__codelineno-0-103 name=__codelineno-0-103 href=#__codelineno-0-103></a>    <span class=n>basic_agent</span> <span class=o>=</span> <span class=n>ConversableAgent</span><span class=p>(</span>
<a id=__codelineno-0-104 name=__codelineno-0-104 href=#__codelineno-0-104></a>        <span class=n>name</span><span class=o>=</span><span class=s2>&quot;basic_agent&quot;</span><span class=p>,</span>
<a id=__codelineno-0-105 name=__codelineno-0-105 href=#__codelineno-0-105></a>        <span class=n>system_message</span><span class=o>=</span><span class=s2>&quot;&quot;&quot;You are a basic agent that handles simple tasks efficiently.</span>
<a id=__codelineno-0-106 name=__codelineno-0-106 href=#__codelineno-0-106></a><span class=s2>        You can answer common knowledge questions and perform basic calculations.</span>
<a id=__codelineno-0-107 name=__codelineno-0-107 href=#__codelineno-0-107></a>
<a id=__codelineno-0-108 name=__codelineno-0-108 href=#__codelineno-0-108></a><span class=s2>        You MUST provide your responses in the required structured format, including a confidence score from 1-10.</span>
<a id=__codelineno-0-109 name=__codelineno-0-109 href=#__codelineno-0-109></a>
<a id=__codelineno-0-110 name=__codelineno-0-110 href=#__codelineno-0-110></a><span class=s2>        If a query requires specialized knowledge beyond your capabilities or is complex, set needs_escalation to True</span>
<a id=__codelineno-0-111 name=__codelineno-0-111 href=#__codelineno-0-111></a><span class=s2>        and provide a brief reason in escalation_reason.</span>
<a id=__codelineno-0-112 name=__codelineno-0-112 href=#__codelineno-0-112></a>
<a id=__codelineno-0-113 name=__codelineno-0-113 href=#__codelineno-0-113></a><span class=s2>        Confidence level guide:</span>
<a id=__codelineno-0-114 name=__codelineno-0-114 href=#__codelineno-0-114></a><span class=s2>        - 1-3: Very uncertain, likely to be incorrect</span>
<a id=__codelineno-0-115 name=__codelineno-0-115 href=#__codelineno-0-115></a><span class=s2>        - 4-6: Moderate confidence, might be correct</span>
<a id=__codelineno-0-116 name=__codelineno-0-116 href=#__codelineno-0-116></a><span class=s2>        - 7-8: Good confidence, probably correct</span>
<a id=__codelineno-0-117 name=__codelineno-0-117 href=#__codelineno-0-117></a><span class=s2>        - 9-10: High confidence, almost certainly correct</span>
<a id=__codelineno-0-118 name=__codelineno-0-118 href=#__codelineno-0-118></a>
<a id=__codelineno-0-119 name=__codelineno-0-119 href=#__codelineno-0-119></a><span class=s2>        For simple factual questions and basic calculations that you can handle well, your confidence should be 8-10.</span>
<a id=__codelineno-0-120 name=__codelineno-0-120 href=#__codelineno-0-120></a><span class=s2>        For it&#39;s not a simple question, rate accordingly lower.</span>
<a id=__codelineno-0-121 name=__codelineno-0-121 href=#__codelineno-0-121></a>
<a id=__codelineno-0-122 name=__codelineno-0-122 href=#__codelineno-0-122></a><span class=s2>        Always call the answer_question_basic tool when answering.</span>
<a id=__codelineno-0-123 name=__codelineno-0-123 href=#__codelineno-0-123></a><span class=s2>        &quot;&quot;&quot;</span><span class=p>,</span>
<a id=__codelineno-0-124 name=__codelineno-0-124 href=#__codelineno-0-124></a>        <span class=n>functions</span><span class=o>=</span><span class=p>[</span><span class=n>answer_question_basic</span><span class=p>],</span>
<a id=__codelineno-0-125 name=__codelineno-0-125 href=#__codelineno-0-125></a>        <span class=n>llm_config</span><span class=o>=</span><span class=n>LLMConfig</span><span class=p>(</span>
<a id=__codelineno-0-126 name=__codelineno-0-126 href=#__codelineno-0-126></a>            <span class=n>api_type</span><span class=o>=</span><span class=s2>&quot;openai&quot;</span><span class=p>,</span>
<a id=__codelineno-0-127 name=__codelineno-0-127 href=#__codelineno-0-127></a>            <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-4o-mini&quot;</span><span class=p>,</span>
<a id=__codelineno-0-128 name=__codelineno-0-128 href=#__codelineno-0-128></a>            <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
<a id=__codelineno-0-129 name=__codelineno-0-129 href=#__codelineno-0-129></a>            <span class=n>cache_seed</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
<a id=__codelineno-0-130 name=__codelineno-0-130 href=#__codelineno-0-130></a>        <span class=p>)</span>
<a id=__codelineno-0-131 name=__codelineno-0-131 href=#__codelineno-0-131></a>    <span class=p>)</span>
<a id=__codelineno-0-132 name=__codelineno-0-132 href=#__codelineno-0-132></a>
<a id=__codelineno-0-133 name=__codelineno-0-133 href=#__codelineno-0-133></a>    <span class=n>intermediate_agent</span> <span class=o>=</span> <span class=n>ConversableAgent</span><span class=p>(</span>
<a id=__codelineno-0-134 name=__codelineno-0-134 href=#__codelineno-0-134></a>        <span class=n>name</span><span class=o>=</span><span class=s2>&quot;intermediate_agent&quot;</span><span class=p>,</span>
<a id=__codelineno-0-135 name=__codelineno-0-135 href=#__codelineno-0-135></a>        <span class=n>system_message</span><span class=o>=</span><span class=s2>&quot;&quot;&quot;You are an intermediate agent that handles moderately complex tasks.</span>
<a id=__codelineno-0-136 name=__codelineno-0-136 href=#__codelineno-0-136></a><span class=s2>        You can perform more nuanced analysis, provide detailed explanations, and handle domain-specific knowledge.</span>
<a id=__codelineno-0-137 name=__codelineno-0-137 href=#__codelineno-0-137></a>
<a id=__codelineno-0-138 name=__codelineno-0-138 href=#__codelineno-0-138></a><span class=s2>        You MUST provide your responses in the required structured format, including a confidence score from 1-10.</span>
<a id=__codelineno-0-139 name=__codelineno-0-139 href=#__codelineno-0-139></a>
<a id=__codelineno-0-140 name=__codelineno-0-140 href=#__codelineno-0-140></a><span class=s2>        If a query requires deep expertise or is very complex beyond your capabilities, set needs_escalation to True</span>
<a id=__codelineno-0-141 name=__codelineno-0-141 href=#__codelineno-0-141></a><span class=s2>        and provide a brief reason in escalation_reason.</span>
<a id=__codelineno-0-142 name=__codelineno-0-142 href=#__codelineno-0-142></a>
<a id=__codelineno-0-143 name=__codelineno-0-143 href=#__codelineno-0-143></a><span class=s2>        Confidence level guide:</span>
<a id=__codelineno-0-144 name=__codelineno-0-144 href=#__codelineno-0-144></a><span class=s2>        - 1-3: Very uncertain, likely to be incorrect</span>
<a id=__codelineno-0-145 name=__codelineno-0-145 href=#__codelineno-0-145></a><span class=s2>        - 4-6: Moderate confidence, might be correct</span>
<a id=__codelineno-0-146 name=__codelineno-0-146 href=#__codelineno-0-146></a><span class=s2>        - 7-8: Good confidence, probably correct</span>
<a id=__codelineno-0-147 name=__codelineno-0-147 href=#__codelineno-0-147></a><span class=s2>        - 9-10: High confidence, almost certainly correct</span>
<a id=__codelineno-0-148 name=__codelineno-0-148 href=#__codelineno-0-148></a>
<a id=__codelineno-0-149 name=__codelineno-0-149 href=#__codelineno-0-149></a><span class=s2>        For questions within your knowledge domain that you can handle well, your confidence should be 8-10.</span>
<a id=__codelineno-0-150 name=__codelineno-0-150 href=#__codelineno-0-150></a><span class=s2>        For more specialized or complex questions where you&#39;re less certain, rate accordingly lower.</span>
<a id=__codelineno-0-151 name=__codelineno-0-151 href=#__codelineno-0-151></a><span class=s2>        &quot;&quot;&quot;</span><span class=p>,</span>
<a id=__codelineno-0-152 name=__codelineno-0-152 href=#__codelineno-0-152></a>        <span class=n>functions</span><span class=o>=</span><span class=p>[</span><span class=n>answer_question_intermediate</span><span class=p>],</span>
<a id=__codelineno-0-153 name=__codelineno-0-153 href=#__codelineno-0-153></a>        <span class=n>llm_config</span><span class=o>=</span><span class=n>LLMConfig</span><span class=p>(</span>
<a id=__codelineno-0-154 name=__codelineno-0-154 href=#__codelineno-0-154></a>            <span class=n>api_type</span><span class=o>=</span><span class=s2>&quot;openai&quot;</span><span class=p>,</span>
<a id=__codelineno-0-155 name=__codelineno-0-155 href=#__codelineno-0-155></a>            <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-4o&quot;</span><span class=p>,</span>
<a id=__codelineno-0-156 name=__codelineno-0-156 href=#__codelineno-0-156></a>            <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
<a id=__codelineno-0-157 name=__codelineno-0-157 href=#__codelineno-0-157></a>            <span class=n>seed</span><span class=o>=</span><span class=mi>42</span><span class=p>,</span>
<a id=__codelineno-0-158 name=__codelineno-0-158 href=#__codelineno-0-158></a>        <span class=p>)</span>
<a id=__codelineno-0-159 name=__codelineno-0-159 href=#__codelineno-0-159></a>    <span class=p>)</span>
<a id=__codelineno-0-160 name=__codelineno-0-160 href=#__codelineno-0-160></a>
<a id=__codelineno-0-161 name=__codelineno-0-161 href=#__codelineno-0-161></a>    <span class=n>advanced_agent</span> <span class=o>=</span> <span class=n>ConversableAgent</span><span class=p>(</span>
<a id=__codelineno-0-162 name=__codelineno-0-162 href=#__codelineno-0-162></a>        <span class=n>name</span><span class=o>=</span><span class=s2>&quot;advanced_agent&quot;</span><span class=p>,</span>
<a id=__codelineno-0-163 name=__codelineno-0-163 href=#__codelineno-0-163></a>        <span class=n>system_message</span><span class=o>=</span><span class=s2>&quot;&quot;&quot;You are an advanced agent with extensive knowledge and reasoning capabilities.</span>
<a id=__codelineno-0-164 name=__codelineno-0-164 href=#__codelineno-0-164></a><span class=s2>        You can handle complex reasoning, specialized domains, and difficult problem-solving tasks.</span>
<a id=__codelineno-0-165 name=__codelineno-0-165 href=#__codelineno-0-165></a>
<a id=__codelineno-0-166 name=__codelineno-0-166 href=#__codelineno-0-166></a><span class=s2>        You MUST provide your responses in the required structured format, including a confidence score from 1-10.</span>
<a id=__codelineno-0-167 name=__codelineno-0-167 href=#__codelineno-0-167></a>
<a id=__codelineno-0-168 name=__codelineno-0-168 href=#__codelineno-0-168></a><span class=s2>        If a task is beyond even your capabilities, set needs_escalation to True and recommend consulting a human expert</span>
<a id=__codelineno-0-169 name=__codelineno-0-169 href=#__codelineno-0-169></a><span class=s2>        in the escalation_reason field.</span>
<a id=__codelineno-0-170 name=__codelineno-0-170 href=#__codelineno-0-170></a>
<a id=__codelineno-0-171 name=__codelineno-0-171 href=#__codelineno-0-171></a><span class=s2>        Confidence level guide:</span>
<a id=__codelineno-0-172 name=__codelineno-0-172 href=#__codelineno-0-172></a><span class=s2>        - 1-3: Very uncertain, likely to be incorrect</span>
<a id=__codelineno-0-173 name=__codelineno-0-173 href=#__codelineno-0-173></a><span class=s2>        - 4-6: Moderate confidence, might be correct</span>
<a id=__codelineno-0-174 name=__codelineno-0-174 href=#__codelineno-0-174></a><span class=s2>        - 7-8: Good confidence, probably correct</span>
<a id=__codelineno-0-175 name=__codelineno-0-175 href=#__codelineno-0-175></a><span class=s2>        - 9-10: High confidence, almost certainly correct</span>
<a id=__codelineno-0-176 name=__codelineno-0-176 href=#__codelineno-0-176></a>
<a id=__codelineno-0-177 name=__codelineno-0-177 href=#__codelineno-0-177></a><span class=s2>        For questions that you can handle well, your confidence should be 8-10.</span>
<a id=__codelineno-0-178 name=__codelineno-0-178 href=#__codelineno-0-178></a><span class=s2>        For extremely specialized or cutting-edge questions where you&#39;re less certain, rate accordingly lower.</span>
<a id=__codelineno-0-179 name=__codelineno-0-179 href=#__codelineno-0-179></a><span class=s2>        &quot;&quot;&quot;</span><span class=p>,</span>
<a id=__codelineno-0-180 name=__codelineno-0-180 href=#__codelineno-0-180></a>        <span class=n>functions</span><span class=o>=</span><span class=p>[</span><span class=n>answer_question_advanced</span><span class=p>],</span>
<a id=__codelineno-0-181 name=__codelineno-0-181 href=#__codelineno-0-181></a>        <span class=n>llm_config</span><span class=o>=</span><span class=n>LLMConfig</span><span class=p>(</span>
<a id=__codelineno-0-182 name=__codelineno-0-182 href=#__codelineno-0-182></a>            <span class=n>api_type</span><span class=o>=</span><span class=s2>&quot;anthropic&quot;</span><span class=p>,</span>
<a id=__codelineno-0-183 name=__codelineno-0-183 href=#__codelineno-0-183></a>            <span class=n>model</span><span class=o>=</span><span class=s2>&quot;claude-3-7-sonnet-20250219&quot;</span><span class=p>,</span>
<a id=__codelineno-0-184 name=__codelineno-0-184 href=#__codelineno-0-184></a>            <span class=n>seed</span><span class=o>=</span><span class=mi>42</span><span class=p>,</span>
<a id=__codelineno-0-185 name=__codelineno-0-185 href=#__codelineno-0-185></a>        <span class=p>)</span>
<a id=__codelineno-0-186 name=__codelineno-0-186 href=#__codelineno-0-186></a>    <span class=p>)</span>
<a id=__codelineno-0-187 name=__codelineno-0-187 href=#__codelineno-0-187></a>
<a id=__codelineno-0-188 name=__codelineno-0-188 href=#__codelineno-0-188></a>    <span class=c1># Create a user proxy agent</span>
<a id=__codelineno-0-189 name=__codelineno-0-189 href=#__codelineno-0-189></a>    <span class=n>user_proxy</span> <span class=o>=</span> <span class=n>UserProxyAgent</span><span class=p>(</span>
<a id=__codelineno-0-190 name=__codelineno-0-190 href=#__codelineno-0-190></a>        <span class=n>name</span><span class=o>=</span><span class=s2>&quot;user_proxy&quot;</span><span class=p>,</span>
<a id=__codelineno-0-191 name=__codelineno-0-191 href=#__codelineno-0-191></a>        <span class=n>system_message</span><span class=o>=</span><span class=s2>&quot;You are a proxy for the human user.&quot;</span><span class=p>,</span>
<a id=__codelineno-0-192 name=__codelineno-0-192 href=#__codelineno-0-192></a>        <span class=n>human_input_mode</span><span class=o>=</span><span class=s2>&quot;ALWAYS&quot;</span>
<a id=__codelineno-0-193 name=__codelineno-0-193 href=#__codelineno-0-193></a>    <span class=p>)</span>
<a id=__codelineno-0-194 name=__codelineno-0-194 href=#__codelineno-0-194></a>
<a id=__codelineno-0-195 name=__codelineno-0-195 href=#__codelineno-0-195></a>    <span class=n>triage_agent</span><span class=o>.</span><span class=n>handoffs</span><span class=o>.</span><span class=n>set_after_work</span><span class=p>(</span><span class=n>RevertToUserTarget</span><span class=p>())</span>
<a id=__codelineno-0-196 name=__codelineno-0-196 href=#__codelineno-0-196></a>
<a id=__codelineno-0-197 name=__codelineno-0-197 href=#__codelineno-0-197></a>    <span class=c1># Register escalation paths for the basic agent</span>
<a id=__codelineno-0-198 name=__codelineno-0-198 href=#__codelineno-0-198></a>
<a id=__codelineno-0-199 name=__codelineno-0-199 href=#__codelineno-0-199></a>    <span class=c1># Escalate based on agent-specific context variables</span>
<a id=__codelineno-0-200 name=__codelineno-0-200 href=#__codelineno-0-200></a>    <span class=n>basic_agent</span><span class=o>.</span><span class=n>handoffs</span><span class=o>.</span><span class=n>add_context_condition</span><span class=p>(</span>
<a id=__codelineno-0-201 name=__codelineno-0-201 href=#__codelineno-0-201></a>        <span class=n>OnContextCondition</span><span class=p>(</span>
<a id=__codelineno-0-202 name=__codelineno-0-202 href=#__codelineno-0-202></a>            <span class=n>target</span><span class=o>=</span><span class=n>AgentTarget</span><span class=p>(</span><span class=n>intermediate_agent</span><span class=p>),</span>
<a id=__codelineno-0-203 name=__codelineno-0-203 href=#__codelineno-0-203></a>            <span class=n>condition</span><span class=o>=</span><span class=n>ExpressionContextCondition</span><span class=p>(</span><span class=n>expression</span><span class=o>=</span><span class=n>ContextExpression</span><span class=p>(</span><span class=s2>&quot;$</span><span class=si>{basic_agent_confidence}</span><span class=s2> &gt; 0 and $</span><span class=si>{basic_agent_confidence}</span><span class=s2> &lt; 8&quot;</span><span class=p>))</span>
<a id=__codelineno-0-204 name=__codelineno-0-204 href=#__codelineno-0-204></a>            <span class=p>)</span>
<a id=__codelineno-0-205 name=__codelineno-0-205 href=#__codelineno-0-205></a>        <span class=p>)</span>
<a id=__codelineno-0-206 name=__codelineno-0-206 href=#__codelineno-0-206></a>    <span class=n>basic_agent</span><span class=o>.</span><span class=n>handoffs</span><span class=o>.</span><span class=n>set_after_work</span><span class=p>(</span><span class=n>StayTarget</span><span class=p>())</span>
<a id=__codelineno-0-207 name=__codelineno-0-207 href=#__codelineno-0-207></a>
<a id=__codelineno-0-208 name=__codelineno-0-208 href=#__codelineno-0-208></a>    <span class=c1># Register escalation paths for the intermediate agent</span>
<a id=__codelineno-0-209 name=__codelineno-0-209 href=#__codelineno-0-209></a>
<a id=__codelineno-0-210 name=__codelineno-0-210 href=#__codelineno-0-210></a>    <span class=c1># Escalate based on agent-specific context variables</span>
<a id=__codelineno-0-211 name=__codelineno-0-211 href=#__codelineno-0-211></a>    <span class=n>intermediate_agent</span><span class=o>.</span><span class=n>handoffs</span><span class=o>.</span><span class=n>add_context_condition</span><span class=p>(</span>
<a id=__codelineno-0-212 name=__codelineno-0-212 href=#__codelineno-0-212></a>        <span class=n>OnContextCondition</span><span class=p>(</span>
<a id=__codelineno-0-213 name=__codelineno-0-213 href=#__codelineno-0-213></a>            <span class=n>target</span><span class=o>=</span><span class=n>AgentTarget</span><span class=p>(</span><span class=n>advanced_agent</span><span class=p>),</span>
<a id=__codelineno-0-214 name=__codelineno-0-214 href=#__codelineno-0-214></a>            <span class=n>condition</span><span class=o>=</span><span class=n>ExpressionContextCondition</span><span class=p>(</span><span class=n>expression</span><span class=o>=</span><span class=n>ContextExpression</span><span class=p>(</span><span class=s2>&quot;$</span><span class=si>{intermediate_agent_confidence}</span><span class=s2> &gt; 0 and $</span><span class=si>{intermediate_agent_confidence}</span><span class=s2> &lt; 8&quot;</span><span class=p>))</span>
<a id=__codelineno-0-215 name=__codelineno-0-215 href=#__codelineno-0-215></a>        <span class=p>)</span>
<a id=__codelineno-0-216 name=__codelineno-0-216 href=#__codelineno-0-216></a>    <span class=p>)</span>
<a id=__codelineno-0-217 name=__codelineno-0-217 href=#__codelineno-0-217></a>
<a id=__codelineno-0-218 name=__codelineno-0-218 href=#__codelineno-0-218></a>    <span class=c1># Advanced agent falls back to user when all agents are insufficient</span>
<a id=__codelineno-0-219 name=__codelineno-0-219 href=#__codelineno-0-219></a>    <span class=n>advanced_agent</span><span class=o>.</span><span class=n>handoffs</span><span class=o>.</span><span class=n>set_after_work</span><span class=p>(</span><span class=n>RevertToUserTarget</span><span class=p>())</span>
<a id=__codelineno-0-220 name=__codelineno-0-220 href=#__codelineno-0-220></a>
<a id=__codelineno-0-221 name=__codelineno-0-221 href=#__codelineno-0-221></a>    <span class=c1># Initial context variables with agent-specific confidence and escalation flags</span>
<a id=__codelineno-0-222 name=__codelineno-0-222 href=#__codelineno-0-222></a>    <span class=n>context_variables</span> <span class=o>=</span> <span class=n>ContextVariables</span><span class=p>(</span><span class=n>data</span><span class=o>=</span><span class=p>{</span>
<a id=__codelineno-0-223 name=__codelineno-0-223 href=#__codelineno-0-223></a>        <span class=c1># Agent-specific variables</span>
<a id=__codelineno-0-224 name=__codelineno-0-224 href=#__codelineno-0-224></a>        <span class=s2>&quot;basic_agent_confidence&quot;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
<a id=__codelineno-0-225 name=__codelineno-0-225 href=#__codelineno-0-225></a>        <span class=s2>&quot;intermediate_agent_confidence&quot;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
<a id=__codelineno-0-226 name=__codelineno-0-226 href=#__codelineno-0-226></a>        <span class=s2>&quot;advanced_agent_confidence&quot;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
<a id=__codelineno-0-227 name=__codelineno-0-227 href=#__codelineno-0-227></a>
<a id=__codelineno-0-228 name=__codelineno-0-228 href=#__codelineno-0-228></a>        <span class=c1># Global tracking variables</span>
<a id=__codelineno-0-229 name=__codelineno-0-229 href=#__codelineno-0-229></a>        <span class=s2>&quot;escalation_count&quot;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
<a id=__codelineno-0-230 name=__codelineno-0-230 href=#__codelineno-0-230></a>        <span class=s2>&quot;last_escalation_reason&quot;</span><span class=p>:</span> <span class=s2>&quot;&quot;</span><span class=p>,</span>
<a id=__codelineno-0-231 name=__codelineno-0-231 href=#__codelineno-0-231></a>        <span class=s2>&quot;last_escalating_agent&quot;</span><span class=p>:</span> <span class=s2>&quot;&quot;</span><span class=p>,</span>
<a id=__codelineno-0-232 name=__codelineno-0-232 href=#__codelineno-0-232></a>
<a id=__codelineno-0-233 name=__codelineno-0-233 href=#__codelineno-0-233></a>        <span class=s2>&quot;current_question&quot;</span><span class=p>:</span> <span class=s2>&quot;&quot;</span>
<a id=__codelineno-0-234 name=__codelineno-0-234 href=#__codelineno-0-234></a>    <span class=p>})</span>
<a id=__codelineno-0-235 name=__codelineno-0-235 href=#__codelineno-0-235></a>
<a id=__codelineno-0-236 name=__codelineno-0-236 href=#__codelineno-0-236></a>    <span class=n>basic_question</span> <span class=o>=</span> <span class=s2>&quot;What is 100 divided by 5?&quot;</span>
<a id=__codelineno-0-237 name=__codelineno-0-237 href=#__codelineno-0-237></a>    <span class=n>intermediate_question</span> <span class=o>=</span> <span class=p>(</span>
<a id=__codelineno-0-238 name=__codelineno-0-238 href=#__codelineno-0-238></a>        <span class=s2>&quot;Calculate the energy of a quantum system with three particles in a harmonic oscillator potential. &quot;</span>
<a id=__codelineno-0-239 name=__codelineno-0-239 href=#__codelineno-0-239></a>        <span class=s2>&quot;The first particle has energy level n=2, the second particle has energy level n=1, and the third particle has energy level n=0. &quot;</span>
<a id=__codelineno-0-240 name=__codelineno-0-240 href=#__codelineno-0-240></a>        <span class=s2>&quot;Assume the harmonic oscillator has a frequency of  = 2.5 eV/.&quot;</span>
<a id=__codelineno-0-241 name=__codelineno-0-241 href=#__codelineno-0-241></a>        <span class=p>)</span>
<a id=__codelineno-0-242 name=__codelineno-0-242 href=#__codelineno-0-242></a>    <span class=n>advanced_question</span> <span class=o>=</span> <span class=p>(</span>
<a id=__codelineno-0-243 name=__codelineno-0-243 href=#__codelineno-0-243></a>        <span class=s2>&quot;Develop a mathematical model for optimizing the tradeoff between exploration and exploitation in reinforcement learning for a &quot;</span>
<a id=__codelineno-0-244 name=__codelineno-0-244 href=#__codelineno-0-244></a>        <span class=s2>&quot;non-stationary multi-armed bandit problem where the reward distributions shift according to a hidden Markov model. &quot;</span>
<a id=__codelineno-0-245 name=__codelineno-0-245 href=#__codelineno-0-245></a>        <span class=s2>&quot;Include the formal equations for the Upper Confidence Bound (UCB) algorithm modification you would propose, and explain &quot;</span>
<a id=__codelineno-0-246 name=__codelineno-0-246 href=#__codelineno-0-246></a>        <span class=s2>&quot;how your approach addresses the non-stationarity challenge better than Thompson Sampling with a sliding window.&quot;</span>
<a id=__codelineno-0-247 name=__codelineno-0-247 href=#__codelineno-0-247></a>        <span class=p>)</span>
<a id=__codelineno-0-248 name=__codelineno-0-248 href=#__codelineno-0-248></a>
<a id=__codelineno-0-249 name=__codelineno-0-249 href=#__codelineno-0-249></a>    <span class=n>agent_pattern</span> <span class=o>=</span> <span class=n>DefaultPattern</span><span class=p>(</span>
<a id=__codelineno-0-250 name=__codelineno-0-250 href=#__codelineno-0-250></a>        <span class=n>agents</span><span class=o>=</span><span class=p>[</span>
<a id=__codelineno-0-251 name=__codelineno-0-251 href=#__codelineno-0-251></a>            <span class=n>basic_agent</span><span class=p>,</span>
<a id=__codelineno-0-252 name=__codelineno-0-252 href=#__codelineno-0-252></a>            <span class=n>intermediate_agent</span><span class=p>,</span>
<a id=__codelineno-0-253 name=__codelineno-0-253 href=#__codelineno-0-253></a>            <span class=n>advanced_agent</span><span class=p>,</span>
<a id=__codelineno-0-254 name=__codelineno-0-254 href=#__codelineno-0-254></a>            <span class=n>triage_agent</span>
<a id=__codelineno-0-255 name=__codelineno-0-255 href=#__codelineno-0-255></a>        <span class=p>],</span>
<a id=__codelineno-0-256 name=__codelineno-0-256 href=#__codelineno-0-256></a>        <span class=n>initial_agent</span><span class=o>=</span><span class=n>triage_agent</span><span class=p>,</span>
<a id=__codelineno-0-257 name=__codelineno-0-257 href=#__codelineno-0-257></a>        <span class=n>context_variables</span><span class=o>=</span><span class=n>context_variables</span><span class=p>,</span>
<a id=__codelineno-0-258 name=__codelineno-0-258 href=#__codelineno-0-258></a>        <span class=n>group_after_work</span><span class=o>=</span><span class=n>TerminateTarget</span><span class=p>(),</span>
<a id=__codelineno-0-259 name=__codelineno-0-259 href=#__codelineno-0-259></a>        <span class=n>user_agent</span><span class=o>=</span><span class=n>user_proxy</span><span class=p>,</span>
<a id=__codelineno-0-260 name=__codelineno-0-260 href=#__codelineno-0-260></a>    <span class=p>)</span>
<a id=__codelineno-0-261 name=__codelineno-0-261 href=#__codelineno-0-261></a>
<a id=__codelineno-0-262 name=__codelineno-0-262 href=#__codelineno-0-262></a>    <span class=n>chat_result</span><span class=p>,</span> <span class=n>final_context</span><span class=p>,</span> <span class=n>last_speaker</span> <span class=o>=</span> <span class=n>initiate_group_chat</span><span class=p>(</span>
<a id=__codelineno-0-263 name=__codelineno-0-263 href=#__codelineno-0-263></a>        <span class=n>pattern</span><span class=o>=</span><span class=n>agent_pattern</span><span class=p>,</span>
<a id=__codelineno-0-264 name=__codelineno-0-264 href=#__codelineno-0-264></a>        <span class=n>messages</span><span class=o>=</span><span class=n>advanced_question</span><span class=p>,</span> <span class=c1># Try different questions</span>
<a id=__codelineno-0-265 name=__codelineno-0-265 href=#__codelineno-0-265></a>        <span class=n>max_rounds</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>
<a id=__codelineno-0-266 name=__codelineno-0-266 href=#__codelineno-0-266></a>    <span class=p>)</span>
<a id=__codelineno-0-267 name=__codelineno-0-267 href=#__codelineno-0-267></a>
<a id=__codelineno-0-268 name=__codelineno-0-268 href=#__codelineno-0-268></a>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>===== SUMMARY =====</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-0-269 name=__codelineno-0-269 href=#__codelineno-0-269></a>    <span class=nb>print</span><span class=p>(</span><span class=n>chat_result</span><span class=o>.</span><span class=n>summary</span><span class=p>)</span>
<a id=__codelineno-0-270 name=__codelineno-0-270 href=#__codelineno-0-270></a>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n\n</span><span class=s2>===== FINAL CONTEXT VARIABLES =====</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-0-271 name=__codelineno-0-271 href=#__codelineno-0-271></a>    <span class=nb>print</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>final_context</span><span class=o>.</span><span class=n>to_dict</span><span class=p>(),</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>))</span>
<a id=__codelineno-0-272 name=__codelineno-0-272 href=#__codelineno-0-272></a>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n\n</span><span class=s2>===== SPEAKER ORDER =====</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-0-273 name=__codelineno-0-273 href=#__codelineno-0-273></a>    <span class=k>for</span> <span class=n>message</span> <span class=ow>in</span> <span class=n>chat_result</span><span class=o>.</span><span class=n>chat_history</span><span class=p>:</span>
<a id=__codelineno-0-274 name=__codelineno-0-274 href=#__codelineno-0-274></a>        <span class=k>if</span> <span class=s2>&quot;name&quot;</span> <span class=ow>in</span> <span class=n>message</span> <span class=ow>and</span> <span class=n>message</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span> <span class=o>!=</span> <span class=s2>&quot;_Group_Tool_Executor&quot;</span><span class=p>:</span>
<a id=__codelineno-0-275 name=__codelineno-0-275 href=#__codelineno-0-275></a>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>message</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-0-276 name=__codelineno-0-276 href=#__codelineno-0-276></a>
<a id=__codelineno-0-277 name=__codelineno-0-277 href=#__codelineno-0-277></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&quot;__main__&quot;</span><span class=p>:</span>
<a id=__codelineno-0-278 name=__codelineno-0-278 href=#__codelineno-0-278></a>    <span class=n>main</span><span class=p>()</span>
</code></pre></div> <h2 id=output>Output<a class=headerlink href=#output title="Permanent link">#</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=go>user_proxy (to chat_manager):</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=go>Develop a mathematical model for optimizing the tradeoff between exploration and exploitation in reinforcement learning for a non-stationary multi-armed bandit problem where the reward distributions shift according to a hidden Markov model. Include the formal equations for the Upper Confidence Bound (UCB) algorithm modification you would propose, and explain how your approach addresses the non-stationarity challenge better than Thompson Sampling with a sliding window.</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=go>--------------------------------------------------------------------------------</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=go>Next speaker: triage_agent</span>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=go>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; USING AUTO REPLY...</span>
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=go>triage_agent (to chat_manager):</span>
<a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>
<a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=go>***** Suggested tool call (call_euRBGre72VWWOVXA0pYP1MiW): new_question_asked *****</span>
<a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a><span class=go>Arguments:</span>
<a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a><span class=go>{&quot;question&quot;:&quot;Develop a mathematical model for optimizing the tradeoff between exploration and exploitation in reinforcement learning for a non-stationary multi-armed bandit problem where the reward distributions shift according to a hidden Markov model. Include the formal equations for the Upper Confidence Bound (UCB) algorithm modification you would propose, and explain how your approach addresses the non-stationarity challenge better than Thompson Sampling with a sliding window.&quot;}</span>
<a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a><span class=go>***********************************************************************************</span>
<a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a>
<a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a><span class=go>--------------------------------------------------------------------------------</span>
<a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a>
<a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a><span class=go>Next speaker: _Group_Tool_Executor</span>
<a id=__codelineno-1-20 name=__codelineno-1-20 href=#__codelineno-1-20></a>
<a id=__codelineno-1-21 name=__codelineno-1-21 href=#__codelineno-1-21></a><span class=go>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; EXECUTING FUNCTION new_question_asked...</span>
<a id=__codelineno-1-22 name=__codelineno-1-22 href=#__codelineno-1-22></a><span class=go>Call ID: call_euRBGre72VWWOVXA0pYP1MiW</span>
<a id=__codelineno-1-23 name=__codelineno-1-23 href=#__codelineno-1-23></a><span class=go>Input arguments: {&#39;question&#39;: &#39;Develop a mathematical model for optimizing the tradeoff between exploration and exploitation in reinforcement learning for a non-stationary multi-armed bandit problem where the reward distributions shift according to a hidden Markov model. Include the formal equations for the Upper Confidence Bound (UCB) algorithm modification you would propose, and explain how your approach addresses the non-stationarity challenge better than Thompson Sampling with a sliding window.&#39;}</span>
<a id=__codelineno-1-24 name=__codelineno-1-24 href=#__codelineno-1-24></a><span class=go>_Group_Tool_Executor (to chat_manager):</span>
<a id=__codelineno-1-25 name=__codelineno-1-25 href=#__codelineno-1-25></a>
<a id=__codelineno-1-26 name=__codelineno-1-26 href=#__codelineno-1-26></a><span class=go>***** Response from calling tool (call_euRBGre72VWWOVXA0pYP1MiW) *****</span>
<a id=__codelineno-1-27 name=__codelineno-1-27 href=#__codelineno-1-27></a><span class=go>New question received, context variables reset.</span>
<a id=__codelineno-1-28 name=__codelineno-1-28 href=#__codelineno-1-28></a>
<a id=__codelineno-1-29 name=__codelineno-1-29 href=#__codelineno-1-29></a><span class=go>basic_agent try and answer this question:</span>
<a id=__codelineno-1-30 name=__codelineno-1-30 href=#__codelineno-1-30></a><span class=go>Develop a mathematical model for optimizing the tradeoff between exploration and exploitation in reinforcement learning for a non-stationary multi-armed bandit problem where the reward distributions shift according to a hidden Markov model. Include the formal equations for the Upper Confidence Bound (UCB) algorithm modification you would propose, and explain how your approach addresses the non-stationarity challenge better than Thompson Sampling with a sliding window.</span>
<a id=__codelineno-1-31 name=__codelineno-1-31 href=#__codelineno-1-31></a><span class=go>**********************************************************************</span>
<a id=__codelineno-1-32 name=__codelineno-1-32 href=#__codelineno-1-32></a>
<a id=__codelineno-1-33 name=__codelineno-1-33 href=#__codelineno-1-33></a><span class=go>--------------------------------------------------------------------------------</span>
<a id=__codelineno-1-34 name=__codelineno-1-34 href=#__codelineno-1-34></a>
<a id=__codelineno-1-35 name=__codelineno-1-35 href=#__codelineno-1-35></a><span class=go>Next speaker: basic_agent</span>
<a id=__codelineno-1-36 name=__codelineno-1-36 href=#__codelineno-1-36></a>
<a id=__codelineno-1-37 name=__codelineno-1-37 href=#__codelineno-1-37></a><span class=go>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; USING AUTO REPLY...</span>
<a id=__codelineno-1-38 name=__codelineno-1-38 href=#__codelineno-1-38></a><span class=go>basic_agent (to chat_manager):</span>
<a id=__codelineno-1-39 name=__codelineno-1-39 href=#__codelineno-1-39></a>
<a id=__codelineno-1-40 name=__codelineno-1-40 href=#__codelineno-1-40></a><span class=go>***** Suggested tool call (call_xGRPzkjHSKVCDheq7qv3IQUd): answer_question_basic *****</span>
<a id=__codelineno-1-41 name=__codelineno-1-41 href=#__codelineno-1-41></a><span class=go>Arguments:</span>
<a id=__codelineno-1-42 name=__codelineno-1-42 href=#__codelineno-1-42></a><span class=go>{&quot;response&quot;:{&quot;answer&quot;:&quot;This question requires specialized knowledge in reinforcement learning and mathematical modeling, which exceeds my capabilities. I recommend consulting a domain expert or literature on reinforcement learning for a comprehensive answer.&quot;,&quot;confidence&quot;:3,&quot;reasoning&quot;:&quot;The question involves complex concepts in reinforcement learning, including mathematical modeling and algorithm modifications, which are beyond basic knowledge.&quot;,&quot;escalation_reason&quot;:&quot;Complexity of the topic and need for specialized knowledge.&quot;}}</span>
<a id=__codelineno-1-43 name=__codelineno-1-43 href=#__codelineno-1-43></a><span class=go>**************************************************************************************</span>
<a id=__codelineno-1-44 name=__codelineno-1-44 href=#__codelineno-1-44></a>
<a id=__codelineno-1-45 name=__codelineno-1-45 href=#__codelineno-1-45></a><span class=go>--------------------------------------------------------------------------------</span>
<a id=__codelineno-1-46 name=__codelineno-1-46 href=#__codelineno-1-46></a>
<a id=__codelineno-1-47 name=__codelineno-1-47 href=#__codelineno-1-47></a><span class=go>Next speaker: _Group_Tool_Executor</span>
<a id=__codelineno-1-48 name=__codelineno-1-48 href=#__codelineno-1-48></a>
<a id=__codelineno-1-49 name=__codelineno-1-49 href=#__codelineno-1-49></a><span class=go>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; EXECUTING FUNCTION answer_question_basic...</span>
<a id=__codelineno-1-50 name=__codelineno-1-50 href=#__codelineno-1-50></a><span class=go>Call ID: call_xGRPzkjHSKVCDheq7qv3IQUd</span>
<a id=__codelineno-1-51 name=__codelineno-1-51 href=#__codelineno-1-51></a><span class=go>Input arguments: {&#39;response&#39;: {&#39;answer&#39;: &#39;This question requires specialized knowledge in reinforcement learning and mathematical modeling, which exceeds my capabilities. I recommend consulting a domain expert or literature on reinforcement learning for a comprehensive answer.&#39;, &#39;confidence&#39;: 3, &#39;reasoning&#39;: &#39;The question involves complex concepts in reinforcement learning, including mathematical modeling and algorithm modifications, which are beyond basic knowledge.&#39;, &#39;escalation_reason&#39;: &#39;Complexity of the topic and need for specialized knowledge.&#39;}}</span>
<a id=__codelineno-1-52 name=__codelineno-1-52 href=#__codelineno-1-52></a><span class=go>_Group_Tool_Executor (to chat_manager):</span>
<a id=__codelineno-1-53 name=__codelineno-1-53 href=#__codelineno-1-53></a>
<a id=__codelineno-1-54 name=__codelineno-1-54 href=#__codelineno-1-54></a><span class=go>***** Response from calling tool (call_xGRPzkjHSKVCDheq7qv3IQUd) *****</span>
<a id=__codelineno-1-55 name=__codelineno-1-55 href=#__codelineno-1-55></a><span class=go>Need to escalate with confidence 3/10, reason:</span>
<a id=__codelineno-1-56 name=__codelineno-1-56 href=#__codelineno-1-56></a><span class=go>Complexity of the topic and need for specialized knowledge.</span>
<a id=__codelineno-1-57 name=__codelineno-1-57 href=#__codelineno-1-57></a><span class=go>**********************************************************************</span>
<a id=__codelineno-1-58 name=__codelineno-1-58 href=#__codelineno-1-58></a>
<a id=__codelineno-1-59 name=__codelineno-1-59 href=#__codelineno-1-59></a><span class=go>--------------------------------------------------------------------------------</span>
<a id=__codelineno-1-60 name=__codelineno-1-60 href=#__codelineno-1-60></a>
<a id=__codelineno-1-61 name=__codelineno-1-61 href=#__codelineno-1-61></a><span class=go>Next speaker: intermediate_agent</span>
<a id=__codelineno-1-62 name=__codelineno-1-62 href=#__codelineno-1-62></a>
<a id=__codelineno-1-63 name=__codelineno-1-63 href=#__codelineno-1-63></a><span class=go>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; USING AUTO REPLY...</span>
<a id=__codelineno-1-64 name=__codelineno-1-64 href=#__codelineno-1-64></a><span class=go>intermediate_agent (to chat_manager):</span>
<a id=__codelineno-1-65 name=__codelineno-1-65 href=#__codelineno-1-65></a>
<a id=__codelineno-1-66 name=__codelineno-1-66 href=#__codelineno-1-66></a><span class=go>***** Suggested tool call (call_HISmt3TOPbCo9OSQI2zplkuo): answer_question_intermediate *****</span>
<a id=__codelineno-1-67 name=__codelineno-1-67 href=#__codelineno-1-67></a><span class=go>Arguments:</span>
<a id=__codelineno-1-68 name=__codelineno-1-68 href=#__codelineno-1-68></a><span class=go>{&quot;response&quot;:{&quot;answer&quot;:&quot;To address the non-stationary multi-armed bandit problem where reward distributions shift according to a hidden Markov model, we can modify the Upper Confidence Bound (UCB) algorithm to better handle non-stationarity. The traditional UCB algorithm is designed for stationary environments, so it needs to be adapted for environments where the reward distributions change over time.\n\n### Modified UCB Algorithm\n\n1. **Incorporate a Decay Factor:** Introduce a decay factor \\( \\gamma \\) to give more weight to recent observations. This helps in adapting to changes in the reward distribution.\n\n2. **UCB Equation:**\n   \\[\n   UCB_i(t) = \\bar{x}_i(t) + c \\sqrt{\\frac{\\log t}{N_i(t)}}\n   \\]\n   where:\n   - \\( \\bar{x}_i(t) \\) is the estimated mean reward for arm \\( i \\) at time \\( t \\), updated with a decay factor.\n   - \\( c \\) is a constant that balances exploration and exploitation.\n   - \\( N_i(t) \\) is the number of times arm \\( i \\) has been played up to time \\( t \\).\n\n3. **Decay Factor Update:**\n   \\[\n   \\bar{x}_i(t) = (1 - \\gamma) \\bar{x}_i(t-1) + \\gamma r_i(t)\n   \\]\n   where \\( r_i(t) \\) is the reward received from arm \\( i \\) at time \\( t \\).\n\n### Addressing Non-Stationarity\n\n- **Adaptation to Changes:** The decay factor allows the algorithm to quickly adapt to changes in the reward distribution, which is crucial in a non-stationary environment.\n- **Comparison with Thompson Sampling with Sliding Window:** While Thompson Sampling with a sliding window also adapts to changes by considering only recent observations, the modified UCB with a decay factor provides a more continuous adaptation mechanism. It does not abruptly discard past data but gradually reduces its influence, which can be more stable and less sensitive to sudden changes.\n\nThis approach provides a balance between maintaining historical information and adapting to new trends, making it potentially more robust in environments modeled by hidden Markov processes.&quot;,&quot;confidence&quot;:7,&quot;reasoning&quot;:&quot;The proposed modification to the UCB algorithm introduces a decay factor to handle non-stationarity, which is a common approach in adaptive algorithms. This method is theoretically sound but requires empirical validation to confirm its effectiveness compared to other methods like Thompson Sampling with a sliding window.&quot;,&quot;escalation_reason&quot;:&quot;The complexity of the mathematical modeling and the need for empirical validation in specific scenarios.&quot;}}</span>
<a id=__codelineno-1-69 name=__codelineno-1-69 href=#__codelineno-1-69></a><span class=go>*********************************************************************************************</span>
<a id=__codelineno-1-70 name=__codelineno-1-70 href=#__codelineno-1-70></a>
<a id=__codelineno-1-71 name=__codelineno-1-71 href=#__codelineno-1-71></a><span class=go>--------------------------------------------------------------------------------</span>
<a id=__codelineno-1-72 name=__codelineno-1-72 href=#__codelineno-1-72></a>
<a id=__codelineno-1-73 name=__codelineno-1-73 href=#__codelineno-1-73></a><span class=go>Next speaker: _Group_Tool_Executor</span>
<a id=__codelineno-1-74 name=__codelineno-1-74 href=#__codelineno-1-74></a>
<a id=__codelineno-1-75 name=__codelineno-1-75 href=#__codelineno-1-75></a><span class=go>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; EXECUTING FUNCTION answer_question_intermediate...</span>
<a id=__codelineno-1-76 name=__codelineno-1-76 href=#__codelineno-1-76></a><span class=go>Call ID: call_HISmt3TOPbCo9OSQI2zplkuo</span>
<a id=__codelineno-1-77 name=__codelineno-1-77 href=#__codelineno-1-77></a><span class=go>Input arguments: {&#39;response&#39;: {&#39;answer&#39;: &#39;To address the non-stationary multi-armed bandit problem where reward distributions shift according to a hidden Markov model, we can modify the Upper Confidence Bound (UCB) algorithm to better handle non-stationarity. The traditional UCB algorithm is designed for stationary environments, so it needs to be adapted for environments where the reward distributions change over time.\n\n### Modified UCB Algorithm\n\n1. **Incorporate a Decay Factor:** Introduce a decay factor \\( \\gamma \\) to give more weight to recent observations. This helps in adapting to changes in the reward distribution.\n\n2. **UCB Equation:**\n   \\[\n   UCB_i(t) = \\bar{x}_i(t) + c \\sqrt{\\frac{\\log t}{N_i(t)}}\n   \\]\n   where:\n   - \\( \\bar{x}_i(t) \\) is the estimated mean reward for arm \\( i \\) at time \\( t \\), updated with a decay factor.\n   - \\( c \\) is a constant that balances exploration and exploitation.\n   - \\( N_i(t) \\) is the number of times arm \\( i \\) has been played up to time \\( t \\).\n\n3. **Decay Factor Update:**\n   \\[\n   \\bar{x}_i(t) = (1 - \\gamma) \\bar{x}_i(t-1) + \\gamma r_i(t)\n   \\]\n   where \\( r_i(t) \\) is the reward received from arm \\( i \\) at time \\( t \\).\n\n### Addressing Non-Stationarity\n\n- **Adaptation to Changes:** The decay factor allows the algorithm to quickly adapt to changes in the reward distribution, which is crucial in a non-stationary environment.\n- **Comparison with Thompson Sampling with Sliding Window:** While Thompson Sampling with a sliding window also adapts to changes by considering only recent observations, the modified UCB with a decay factor provides a more continuous adaptation mechanism. It does not abruptly discard past data but gradually reduces its influence, which can be more stable and less sensitive to sudden changes.\n\nThis approach provides a balance between maintaining historical information and adapting to new trends, making it potentially more robust in environments modeled by hidden Markov processes.&#39;, &#39;confidence&#39;: 7, &#39;reasoning&#39;: &#39;The proposed modification to the UCB algorithm introduces a decay factor to handle non-stationarity, which is a common approach in adaptive algorithms. This method is theoretically sound but requires empirical validation to confirm its effectiveness compared to other methods like Thompson Sampling with a sliding window.&#39;, &#39;escalation_reason&#39;: &#39;The complexity of the mathematical modeling and the need for empirical validation in specific scenarios.&#39;}}</span>
<a id=__codelineno-1-78 name=__codelineno-1-78 href=#__codelineno-1-78></a><span class=go>_Group_Tool_Executor (to chat_manager):</span>
<a id=__codelineno-1-79 name=__codelineno-1-79 href=#__codelineno-1-79></a>
<a id=__codelineno-1-80 name=__codelineno-1-80 href=#__codelineno-1-80></a><span class=go>***** Response from calling tool (call_HISmt3TOPbCo9OSQI2zplkuo) *****</span>
<a id=__codelineno-1-81 name=__codelineno-1-81 href=#__codelineno-1-81></a><span class=go>Need to escalate with confidence 7/10, reason:</span>
<a id=__codelineno-1-82 name=__codelineno-1-82 href=#__codelineno-1-82></a><span class=go>The complexity of the mathematical modeling and the need for empirical validation in specific scenarios.</span>
<a id=__codelineno-1-83 name=__codelineno-1-83 href=#__codelineno-1-83></a><span class=go>**********************************************************************</span>
<a id=__codelineno-1-84 name=__codelineno-1-84 href=#__codelineno-1-84></a>
<a id=__codelineno-1-85 name=__codelineno-1-85 href=#__codelineno-1-85></a><span class=go>--------------------------------------------------------------------------------</span>
<a id=__codelineno-1-86 name=__codelineno-1-86 href=#__codelineno-1-86></a>
<a id=__codelineno-1-87 name=__codelineno-1-87 href=#__codelineno-1-87></a><span class=go>Next speaker: advanced_agent</span>
<a id=__codelineno-1-88 name=__codelineno-1-88 href=#__codelineno-1-88></a>
<a id=__codelineno-1-89 name=__codelineno-1-89 href=#__codelineno-1-89></a><span class=go>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; USING AUTO REPLY...</span>
<a id=__codelineno-1-90 name=__codelineno-1-90 href=#__codelineno-1-90></a><span class=go>advanced_agent (to chat_manager):</span>
<a id=__codelineno-1-91 name=__codelineno-1-91 href=#__codelineno-1-91></a>
<a id=__codelineno-1-92 name=__codelineno-1-92 href=#__codelineno-1-92></a><span class=go>***** Suggested tool call (toolu_01SPbMXGDwArQyDcAEEZxyrs): answer_question_advanced *****</span>
<a id=__codelineno-1-93 name=__codelineno-1-93 href=#__codelineno-1-93></a><span class=go>Arguments:</span>
<a id=__codelineno-1-94 name=__codelineno-1-94 href=#__codelineno-1-94></a><span class=go>{&quot;response&quot;: {&quot;answer&quot;: &quot;# Mathematical Model for Non-Stationary Multi-Armed Bandit with Hidden Markov Model\n\n## Problem Formulation\n\nLet&#39;s consider a non-stationary multi-armed bandit problem with $K$ arms. The environment evolves according to a hidden Markov model (HMM) with hidden states $s_t \\in \\mathcal{S}$ at each time step $t$. The reward distribution of each arm $i$ at time $t$ depends on the hidden state $s_t$, denoted as $p_i(r|s_t)$.\n\n### Hidden Markov Model Specification\n- State transition matrix: $P(s_{t+1}|s_t)$\n- Initial state distribution: $\\pi_0(s)$\n- Emission probabilities: $p_i(r|s)$ for each arm $i$ and state $s$\n\n## Proposed UCB Modification: HMM-UCB\n\nI propose a modification of the UCB algorithm that incorporates Bayesian inference of the hidden states and adaptive confidence bounds.\n\n### State Inference Component\n\nAt each time step $t$, the algorithm maintains a belief state $b_t(s)$, representing the probability of being in state $s$ at time $t$:\n\n$$b_t(s) = P(s_t = s | h_t)$$\n\nwhere $h_t$ is the history of actions and rewards up to time $t$.\n\nAfter observing a reward $r_t$ from arm $a_t$, we update the belief using Bayes&#39; rule:\n\n$$b_{t+1}(s&#39;) = \\frac{\\sum_{s \\in \\mathcal{S}} P(s&#39;|s)b_t(s)p_{a_t}(r_t|s&#39;)}{\\sum_{s&#39; \\in \\mathcal{S}}\\sum_{s \\in \\mathcal{S}} P(s&#39;|s)b_t(s)p_{a_t}(r_t|s&#39;)}$$\n\n### Adaptive UCB Formula\n\nThe proposed HMM-UCB selects arms according to:\n\n$$a_t = \\arg\\max_i \\left[ \\hat{\\mu}_i(t) + \\alpha \\sqrt{\\frac{\\log(t)}{N_i(t)}} \\cdot \\sqrt{\\mathcal{H}(b_t)} \\right]$$\n\nwhere:\n- $\\hat{\\mu}_i(t) = \\sum_{s \\in \\mathcal{S}} b_t(s)\\hat{\\mu}_i(s,t)$ is the expected reward of arm $i$ under the current belief state\n- $\\hat{\\mu}_i(s,t)$ is the estimated mean reward of arm $i$ in state $s$\n- $N_i(t)$ is the number of times arm $i$ has been selected up to time $t$\n- $\\alpha$ is an exploration parameter\n- $\\mathcal{H}(b_t) = -\\sum_{s \\in \\mathcal{S}} b_t(s)\\log b_t(s)$ is the entropy of the belief state\n\n### State-Dependent Reward Estimates\n\nFor each state $s$ and arm $i$, we maintain estimates:\n\n$$\\hat{\\mu}_i(s,t) = \\frac{\\sum_{\\tau=1}^{t-1} r_{\\tau} \\cdot \\mathbb{I}\\{a_{\\tau}=i\\} \\cdot b_{\\tau}(s)}{\\sum_{\\tau=1}^{t-1} \\mathbb{I}\\{a_{\\tau}=i\\} \\cdot b_{\\tau}(s) + \\epsilon}$$\n\nwhere $\\epsilon$ is a small constant to avoid division by zero.\n\n## Advantages Over Thompson Sampling with Sliding Window\n\n1. **Explicit Modeling of State Transitions**: Unlike sliding window approaches that implicitly assume recent data is more relevant, HMM-UCB explicitly models how the environment changes through the transition matrix $P(s_{t+1}|s_t)$.\n\n2. **Adaptive Exploration**: The exploration term scales with the entropy of the belief state $\\mathcal{H}(b_t)$. When there is high uncertainty about the current state (high entropy), the algorithm increases exploration to gather more information. In contrast, Thompson Sampling with sliding window uses a fixed exploration strategy regardless of state uncertainty.\n\n3. **Efficient Use of Historical Data**: Thompson Sampling with sliding window discards data outside the window entirely. HMM-UCB utilizes all historical data but weights it according to the inferred state sequence, providing more statistically efficient estimates when transitions are infrequent.\n\n4. **Predictive Capability**: By leveraging the known transition dynamics, HMM-UCB can anticipate state changes before they occur. Sliding window approaches can only react to changes after they have happened and enough data has been collected.\n\n5. **Theoretical Guarantees**: The HMM-UCB approach has stronger theoretical regret bounds in environments where the number of state transitions is sublinear in the time horizon, as it efficiently identifies and tracks the hidden states.\n\nThe key innovation in this approach is the incorporation of the belief state entropy into the exploration term, which adaptively increases exploration during periods of uncertainty about the environment&#39;s state, providing a principled way to balance exploration and exploitation in non-stationary environments governed by HMMs.&quot;, &quot;confidence&quot;: 9, &quot;reasoning&quot;: &quot;This response provides a comprehensive mathematical model for the non-stationary multi-armed bandit problem with rewards governed by a hidden Markov model. It includes:\n\n1. A formal problem formulation with clear mathematical notation\n2. A novel UCB algorithm modification (HMM-UCB) with complete equations for:\n   - Belief state updates using Bayesian inference\n   - Adaptive UCB formula that incorporates belief state entropy\n   - State-dependent reward estimation\n3. A detailed explanation of five specific advantages over Thompson Sampling with sliding window\n\nThe approach is theoretically sound and addresses the exact requirements of the question. It builds on established principles in reinforcement learning and Bayesian inference while offering a novel contribution through the entropy-weighted exploration term. The mathematical formalism is correct and the solution directly addresses the non-stationarity challenge posed by the hidden Markov model structure.\n\nMy confidence is high because this solution is based on established theoretical frameworks for handling non-stationary bandits and HMMs. The proposed approach has strong theoretical justification and addresses the specific requirements mentioned in the question.&quot;, &quot;escalation_reason&quot;: null}}</span>
<a id=__codelineno-1-95 name=__codelineno-1-95 href=#__codelineno-1-95></a><span class=go>******************************************************************************************</span>
<a id=__codelineno-1-96 name=__codelineno-1-96 href=#__codelineno-1-96></a>
<a id=__codelineno-1-97 name=__codelineno-1-97 href=#__codelineno-1-97></a><span class=go>--------------------------------------------------------------------------------</span>
<a id=__codelineno-1-98 name=__codelineno-1-98 href=#__codelineno-1-98></a>
<a id=__codelineno-1-99 name=__codelineno-1-99 href=#__codelineno-1-99></a><span class=go>Next speaker: _Group_Tool_Executor</span>
<a id=__codelineno-1-100 name=__codelineno-1-100 href=#__codelineno-1-100></a>
<a id=__codelineno-1-101 name=__codelineno-1-101 href=#__codelineno-1-101></a><span class=go>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; EXECUTING FUNCTION answer_question_advanced...</span>
<a id=__codelineno-1-102 name=__codelineno-1-102 href=#__codelineno-1-102></a><span class=go>Call ID: toolu_01SPbMXGDwArQyDcAEEZxyrs</span>
<a id=__codelineno-1-103 name=__codelineno-1-103 href=#__codelineno-1-103></a><span class=go>Input arguments: {&#39;response&#39;: {&#39;answer&#39;: &quot;# Mathematical Model for Non-Stationary Multi-Armed Bandit with Hidden Markov Model\n\n## Problem Formulation\n\nLet&#39;s consider a non-stationary multi-armed bandit problem with $K$ arms. The environment evolves according to a hidden Markov model (HMM) with hidden states $s_t \\in \\mathcal{S}$ at each time step $t$. The reward distribution of each arm $i$ at time $t$ depends on the hidden state $s_t$, denoted as $p_i(r|s_t)$.\n\n### Hidden Markov Model Specification\n- State transition matrix: $P(s_{t+1}|s_t)$\n- Initial state distribution: $\\pi_0(s)$\n- Emission probabilities: $p_i(r|s)$ for each arm $i$ and state $s$\n\n## Proposed UCB Modification: HMM-UCB\n\nI propose a modification of the UCB algorithm that incorporates Bayesian inference of the hidden states and adaptive confidence bounds.\n\n### State Inference Component\n\nAt each time step $t$, the algorithm maintains a belief state $b_t(s)$, representing the probability of being in state $s$ at time $t$:\n\n$$b_t(s) = P(s_t = s | h_t)$$\n\nwhere $h_t$ is the history of actions and rewards up to time $t$.\n\nAfter observing a reward $r_t$ from arm $a_t$, we update the belief using Bayes&#39; rule:\n\n$$b_{t+1}(s&#39;) = \\frac{\\sum_{s \\in \\mathcal{S}} P(s&#39;|s)b_t(s)p_{a_t}(r_t|s&#39;)}{\\sum_{s&#39; \\in \\mathcal{S}}\\sum_{s \\in \\mathcal{S}} P(s&#39;|s)b_t(s)p_{a_t}(r_t|s&#39;)}$$\n\n### Adaptive UCB Formula\n\nThe proposed HMM-UCB selects arms according to:\n\n$$a_t = \\arg\\max_i \\left[ \\hat{\\mu}_i(t) + \\alpha \\sqrt{\\frac{\\log(t)}{N_i(t)}} \\cdot \\sqrt{\\mathcal{H}(b_t)} \\right]$$\n\nwhere:\n- $\\hat{\\mu}_i(t) = \\sum_{s \\in \\mathcal{S}} b_t(s)\\hat{\\mu}_i(s,t)$ is the expected reward of arm $i$ under the current belief state\n- $\\hat{\\mu}_i(s,t)$ is the estimated mean reward of arm $i$ in state $s$\n- $N_i(t)$ is the number of times arm $i$ has been selected up to time $t$\n- $\\alpha$ is an exploration parameter\n- $\\mathcal{H}(b_t) = -\\sum_{s \\in \\mathcal{S}} b_t(s)\\log b_t(s)$ is the entropy of the belief state\n\n### State-Dependent Reward Estimates\n\nFor each state $s$ and arm $i$, we maintain estimates:\n\n$$\\hat{\\mu}_i(s,t) = \\frac{\\sum_{\\tau=1}^{t-1} r_{\\tau} \\cdot \\mathbb{I}\\{a_{\\tau}=i\\} \\cdot b_{\\tau}(s)}{\\sum_{\\tau=1}^{t-1} \\mathbb{I}\\{a_{\\tau}=i\\} \\cdot b_{\\tau}(s) + \\epsilon}$$\n\nwhere $\\epsilon$ is a small constant to avoid division by zero.\n\n## Advantages Over Thompson Sampling with Sliding Window\n\n1. **Explicit Modeling of State Transitions**: Unlike sliding window approaches that implicitly assume recent data is more relevant, HMM-UCB explicitly models how the environment changes through the transition matrix $P(s_{t+1}|s_t)$.\n\n2. **Adaptive Exploration**: The exploration term scales with the entropy of the belief state $\\mathcal{H}(b_t)$. When there is high uncertainty about the current state (high entropy), the algorithm increases exploration to gather more information. In contrast, Thompson Sampling with sliding window uses a fixed exploration strategy regardless of state uncertainty.\n\n3. **Efficient Use of Historical Data**: Thompson Sampling with sliding window discards data outside the window entirely. HMM-UCB utilizes all historical data but weights it according to the inferred state sequence, providing more statistically efficient estimates when transitions are infrequent.\n\n4. **Predictive Capability**: By leveraging the known transition dynamics, HMM-UCB can anticipate state changes before they occur. Sliding window approaches can only react to changes after they have happened and enough data has been collected.\n\n5. **Theoretical Guarantees**: The HMM-UCB approach has stronger theoretical regret bounds in environments where the number of state transitions is sublinear in the time horizon, as it efficiently identifies and tracks the hidden states.\n\nThe key innovation in this approach is the incorporation of the belief state entropy into the exploration term, which adaptively increases exploration during periods of uncertainty about the environment&#39;s state, providing a principled way to balance exploration and exploitation in non-stationary environments governed by HMMs.&quot;, &#39;confidence&#39;: 9, &#39;reasoning&#39;: &#39;This response provides a comprehensive mathematical model for the non-stationary multi-armed bandit problem with rewards governed by a hidden Markov model. It includes:\n\n1. A formal problem formulation with clear mathematical notation\n2. A novel UCB algorithm modification (HMM-UCB) with complete equations for:\n   - Belief state updates using Bayesian inference\n   - Adaptive UCB formula that incorporates belief state entropy\n   - State-dependent reward estimation\n3. A detailed explanation of five specific advantages over Thompson Sampling with sliding window\n\nThe approach is theoretically sound and addresses the exact requirements of the question. It builds on established principles in reinforcement learning and Bayesian inference while offering a novel contribution through the entropy-weighted exploration term. The mathematical formalism is correct and the solution directly addresses the non-stationarity challenge posed by the hidden Markov model structure.\n\nMy confidence is high because this solution is based on established theoretical frameworks for handling non-stationary bandits and HMMs. The proposed approach has strong theoretical justification and addresses the specific requirements mentioned in the question.&#39;, &#39;escalation_reason&#39;: None}}</span>
<a id=__codelineno-1-104 name=__codelineno-1-104 href=#__codelineno-1-104></a><span class=go>_Group_Tool_Executor (to chat_manager):</span>
<a id=__codelineno-1-105 name=__codelineno-1-105 href=#__codelineno-1-105></a>
<a id=__codelineno-1-106 name=__codelineno-1-106 href=#__codelineno-1-106></a><span class=go>***** Response from calling tool (toolu_01SPbMXGDwArQyDcAEEZxyrs) *****</span>
<a id=__codelineno-1-107 name=__codelineno-1-107 href=#__codelineno-1-107></a><span class=go>Successfully answered with confidence (9/10):</span>
<a id=__codelineno-1-108 name=__codelineno-1-108 href=#__codelineno-1-108></a><span class=gp># </span>Mathematical<span class=w> </span>Model<span class=w> </span><span class=k>for</span><span class=w> </span>Non-Stationary<span class=w> </span>Multi-Armed<span class=w> </span>Bandit<span class=w> </span>with<span class=w> </span>Hidden<span class=w> </span>Markov<span class=w> </span>Model
<a id=__codelineno-1-109 name=__codelineno-1-109 href=#__codelineno-1-109></a>
<a id=__codelineno-1-110 name=__codelineno-1-110 href=#__codelineno-1-110></a><span class=gp>#</span><span class=c1># Problem Formulation</span>
<a id=__codelineno-1-111 name=__codelineno-1-111 href=#__codelineno-1-111></a>
<a id=__codelineno-1-112 name=__codelineno-1-112 href=#__codelineno-1-112></a><span class=go>Let&#39;s consider a non-stationary multi-armed bandit problem with $K$ arms. The environment evolves according to a hidden Markov model (HMM) with hidden states $s_t \in \mathcal{S}$ at each time step $t$. The reward distribution of each arm $i$ at time $t$ depends on the hidden state $s_t$, denoted as $p_i(r|s_t)$.</span>
<a id=__codelineno-1-113 name=__codelineno-1-113 href=#__codelineno-1-113></a>
<a id=__codelineno-1-114 name=__codelineno-1-114 href=#__codelineno-1-114></a><span class=gp>#</span><span class=c1>## Hidden Markov Model Specification</span>
<a id=__codelineno-1-115 name=__codelineno-1-115 href=#__codelineno-1-115></a><span class=go>- State transition matrix: $P(s_{t+1}|s_t)$</span>
<a id=__codelineno-1-116 name=__codelineno-1-116 href=#__codelineno-1-116></a><span class=go>- Initial state distribution: $\pi_0(s)$</span>
<a id=__codelineno-1-117 name=__codelineno-1-117 href=#__codelineno-1-117></a><span class=go>- Emission probabilities: $p_i(r|s)$ for each arm $i$ and state $s$</span>
<a id=__codelineno-1-118 name=__codelineno-1-118 href=#__codelineno-1-118></a>
<a id=__codelineno-1-119 name=__codelineno-1-119 href=#__codelineno-1-119></a><span class=gp>#</span><span class=c1># Proposed UCB Modification: HMM-UCB</span>
<a id=__codelineno-1-120 name=__codelineno-1-120 href=#__codelineno-1-120></a>
<a id=__codelineno-1-121 name=__codelineno-1-121 href=#__codelineno-1-121></a><span class=go>I propose a modification of the UCB algorithm that incorporates Bayesian inference of the hidden states and adaptive confidence bounds.</span>
<a id=__codelineno-1-122 name=__codelineno-1-122 href=#__codelineno-1-122></a>
<a id=__codelineno-1-123 name=__codelineno-1-123 href=#__codelineno-1-123></a><span class=gp>#</span><span class=c1>## State Inference Component</span>
<a id=__codelineno-1-124 name=__codelineno-1-124 href=#__codelineno-1-124></a>
<a id=__codelineno-1-125 name=__codelineno-1-125 href=#__codelineno-1-125></a><span class=go>At each time step $t$, the algorithm maintains a belief state $b_t(s)$, representing the probability of being in state $s$ at time $t$:</span>
<a id=__codelineno-1-126 name=__codelineno-1-126 href=#__codelineno-1-126></a>
<a id=__codelineno-1-127 name=__codelineno-1-127 href=#__codelineno-1-127></a><span class=gp>$</span><span class=nv>$b_t</span><span class=o>(</span>s<span class=o>)</span><span class=w> </span><span class=o>=</span><span class=w> </span>P<span class=o>(</span><span class=nv>s_t</span><span class=w> </span><span class=o>=</span><span class=w> </span>s<span class=w> </span><span class=p>|</span><span class=w> </span>h_t<span class=o>)</span><span class=nv>$$</span>
<a id=__codelineno-1-128 name=__codelineno-1-128 href=#__codelineno-1-128></a>
<a id=__codelineno-1-129 name=__codelineno-1-129 href=#__codelineno-1-129></a><span class=go>where $h_t$ is the history of actions and rewards up to time $t$.</span>
<a id=__codelineno-1-130 name=__codelineno-1-130 href=#__codelineno-1-130></a>
<a id=__codelineno-1-131 name=__codelineno-1-131 href=#__codelineno-1-131></a><span class=go>After observing a reward $r_t$ from arm $a_t$, we update the belief using Bayes&#39; rule:</span>
<a id=__codelineno-1-132 name=__codelineno-1-132 href=#__codelineno-1-132></a>
<a id=__codelineno-1-133 name=__codelineno-1-133 href=#__codelineno-1-133></a><span class=gp>$</span><span class=nv>$b_</span><span class=o>{</span>t+1<span class=o>}(</span>s<span class=s1>&#39;) = \frac{\sum_{s \in \mathcal{S}} P(s&#39;</span><span class=p>|</span>s<span class=o>)</span>b_t<span class=o>(</span>s<span class=o>)</span>p_<span class=o>{</span>a_t<span class=o>}(</span>r_t<span class=p>|</span>s<span class=s1>&#39;)}{\sum_{s&#39;</span><span class=w> </span><span class=se>\i</span>n<span class=w> </span><span class=se>\m</span>athcal<span class=o>{</span>S<span class=o>}}</span><span class=se>\s</span>um_<span class=o>{</span>s<span class=w> </span><span class=se>\i</span>n<span class=w> </span><span class=se>\m</span>athcal<span class=o>{</span>S<span class=o>}}</span><span class=w> </span>P<span class=o>(</span>s<span class=s1>&#39;|s)b_t(s)p_{a_t}(r_t|s&#39;</span><span class=o>)}</span><span class=nv>$$</span>
<a id=__codelineno-1-134 name=__codelineno-1-134 href=#__codelineno-1-134></a>
<a id=__codelineno-1-135 name=__codelineno-1-135 href=#__codelineno-1-135></a><span class=gp>#</span><span class=c1>## Adaptive UCB Formula</span>
<a id=__codelineno-1-136 name=__codelineno-1-136 href=#__codelineno-1-136></a>
<a id=__codelineno-1-137 name=__codelineno-1-137 href=#__codelineno-1-137></a><span class=go>The proposed HMM-UCB selects arms according to:</span>
<a id=__codelineno-1-138 name=__codelineno-1-138 href=#__codelineno-1-138></a>
<a id=__codelineno-1-139 name=__codelineno-1-139 href=#__codelineno-1-139></a><span class=gp>$</span><span class=nv>$a_t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=se>\a</span>rg<span class=se>\m</span>ax_i<span class=w> </span><span class=se>\l</span>eft<span class=o>[</span><span class=w> </span><span class=se>\h</span>at<span class=o>{</span><span class=se>\m</span>u<span class=o>}</span>_i<span class=o>(</span>t<span class=o>)</span><span class=w> </span>+<span class=w> </span><span class=se>\a</span>lpha<span class=w> </span><span class=se>\s</span>qrt<span class=o>{</span><span class=se>\f</span>rac<span class=o>{</span><span class=se>\l</span>og<span class=o>(</span>t<span class=o>)}{</span>N_i<span class=o>(</span>t<span class=o>)}}</span><span class=w> </span><span class=se>\c</span>dot<span class=w> </span><span class=se>\s</span>qrt<span class=o>{</span><span class=se>\m</span>athcal<span class=o>{</span>H<span class=o>}(</span>b_t<span class=o>)}</span><span class=w> </span><span class=se>\r</span>ight<span class=o>]</span><span class=nv>$$</span>
<a id=__codelineno-1-140 name=__codelineno-1-140 href=#__codelineno-1-140></a>
<a id=__codelineno-1-141 name=__codelineno-1-141 href=#__codelineno-1-141></a><span class=go>where:</span>
<a id=__codelineno-1-142 name=__codelineno-1-142 href=#__codelineno-1-142></a><span class=go>- $\hat{\mu}_i(t) = \sum_{s \in \mathcal{S}} b_t(s)\hat{\mu}_i(s,t)$ is the expected reward of arm $i$ under the current belief state</span>
<a id=__codelineno-1-143 name=__codelineno-1-143 href=#__codelineno-1-143></a><span class=go>- $\hat{\mu}_i(s,t)$ is the estimated mean reward of arm $i$ in state $s$</span>
<a id=__codelineno-1-144 name=__codelineno-1-144 href=#__codelineno-1-144></a><span class=go>- $N_i(t)$ is the number of times arm $i$ has been selected up to time $t$</span>
<a id=__codelineno-1-145 name=__codelineno-1-145 href=#__codelineno-1-145></a><span class=go>- $\alpha$ is an exploration parameter</span>
<a id=__codelineno-1-146 name=__codelineno-1-146 href=#__codelineno-1-146></a><span class=go>- $\mathcal{H}(b_t) = -\sum_{s \in \mathcal{S}} b_t(s)\log b_t(s)$ is the entropy of the belief state</span>
<a id=__codelineno-1-147 name=__codelineno-1-147 href=#__codelineno-1-147></a>
<a id=__codelineno-1-148 name=__codelineno-1-148 href=#__codelineno-1-148></a><span class=gp>#</span><span class=c1>## State-Dependent Reward Estimates</span>
<a id=__codelineno-1-149 name=__codelineno-1-149 href=#__codelineno-1-149></a>
<a id=__codelineno-1-150 name=__codelineno-1-150 href=#__codelineno-1-150></a><span class=go>For each state $s$ and arm $i$, we maintain estimates:</span>
<a id=__codelineno-1-151 name=__codelineno-1-151 href=#__codelineno-1-151></a>
<a id=__codelineno-1-152 name=__codelineno-1-152 href=#__codelineno-1-152></a><span class=gp>$</span>$<span class=se>\h</span>at<span class=o>{</span><span class=se>\m</span>u<span class=o>}</span>_i<span class=o>(</span>s,t<span class=o>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=se>\f</span>rac<span class=o>{</span><span class=se>\s</span>um_<span class=o>{</span><span class=se>\t</span>au<span class=o>=</span><span class=m>1</span><span class=o>}</span>^<span class=o>{</span>t-1<span class=o>}</span><span class=w> </span>r_<span class=o>{</span><span class=se>\t</span>au<span class=o>}</span><span class=w> </span><span class=se>\c</span>dot<span class=w> </span><span class=se>\m</span>athbb<span class=o>{</span>I<span class=o>}</span><span class=se>\{</span>a_<span class=o>{</span><span class=se>\t</span>au<span class=o>}=</span>i<span class=se>\}</span><span class=w> </span><span class=se>\c</span>dot<span class=w> </span>b_<span class=o>{</span><span class=se>\t</span>au<span class=o>}(</span>s<span class=o>)}{</span><span class=se>\s</span>um_<span class=o>{</span><span class=se>\t</span>au<span class=o>=</span><span class=m>1</span><span class=o>}</span>^<span class=o>{</span>t-1<span class=o>}</span><span class=w> </span><span class=se>\m</span>athbb<span class=o>{</span>I<span class=o>}</span><span class=se>\{</span>a_<span class=o>{</span><span class=se>\t</span>au<span class=o>}=</span>i<span class=se>\}</span><span class=w> </span><span class=se>\c</span>dot<span class=w> </span>b_<span class=o>{</span><span class=se>\t</span>au<span class=o>}(</span>s<span class=o>)</span><span class=w> </span>+<span class=w> </span><span class=se>\e</span>psilon<span class=o>}</span><span class=nv>$$</span>
<a id=__codelineno-1-153 name=__codelineno-1-153 href=#__codelineno-1-153></a>
<a id=__codelineno-1-154 name=__codelineno-1-154 href=#__codelineno-1-154></a><span class=go>where $\epsilon$ is a small constant to avoid division by zero.</span>
<a id=__codelineno-1-155 name=__codelineno-1-155 href=#__codelineno-1-155></a>
<a id=__codelineno-1-156 name=__codelineno-1-156 href=#__codelineno-1-156></a><span class=gp>#</span><span class=c1># Advantages Over Thompson Sampling with Sliding Window</span>
<a id=__codelineno-1-157 name=__codelineno-1-157 href=#__codelineno-1-157></a>
<a id=__codelineno-1-158 name=__codelineno-1-158 href=#__codelineno-1-158></a><span class=go>1. **Explicit Modeling of State Transitions**: Unlike sliding window approaches that implicitly assume recent data is more relevant, HMM-UCB explicitly models how the environment changes through the transition matrix $P(s_{t+1}|s_t)$.</span>
<a id=__codelineno-1-159 name=__codelineno-1-159 href=#__codelineno-1-159></a>
<a id=__codelineno-1-160 name=__codelineno-1-160 href=#__codelineno-1-160></a><span class=go>2. **Adaptive Exploration**: The exploration term scales with the entropy of the belief state $\mathcal{H}(b_t)$. When there is high uncertainty about the current state (high entropy), the algorithm increases exploration to gather more information. In contrast, Thompson Sampling with sliding window uses a fixed exploration strategy regardless of state uncertainty.</span>
<a id=__codelineno-1-161 name=__codelineno-1-161 href=#__codelineno-1-161></a>
<a id=__codelineno-1-162 name=__codelineno-1-162 href=#__codelineno-1-162></a><span class=go>3. **Efficient Use of Historical Data**: Thompson Sampling with sliding window discards data outside the window entirely. HMM-UCB utilizes all historical data but weights it according to the inferred state sequence, providing more statistically efficient estimates when transitions are infrequent.</span>
<a id=__codelineno-1-163 name=__codelineno-1-163 href=#__codelineno-1-163></a>
<a id=__codelineno-1-164 name=__codelineno-1-164 href=#__codelineno-1-164></a><span class=go>4. **Predictive Capability**: By leveraging the known transition dynamics, HMM-UCB can anticipate state changes before they occur. Sliding window approaches can only react to changes after they have happened and enough data has been collected.</span>
<a id=__codelineno-1-165 name=__codelineno-1-165 href=#__codelineno-1-165></a>
<a id=__codelineno-1-166 name=__codelineno-1-166 href=#__codelineno-1-166></a><span class=go>5. **Theoretical Guarantees**: The HMM-UCB approach has stronger theoretical regret bounds in environments where the number of state transitions is sublinear in the time horizon, as it efficiently identifies and tracks the hidden states.</span>
<a id=__codelineno-1-167 name=__codelineno-1-167 href=#__codelineno-1-167></a>
<a id=__codelineno-1-168 name=__codelineno-1-168 href=#__codelineno-1-168></a><span class=go>The key innovation in this approach is the incorporation of the belief state entropy into the exploration term, which adaptively increases exploration during periods of uncertainty about the environment&#39;s state, providing a principled way to balance exploration and exploitation in non-stationary environments governed by HMMs.</span>
<a id=__codelineno-1-169 name=__codelineno-1-169 href=#__codelineno-1-169></a><span class=go>***********************************************************************</span>
<a id=__codelineno-1-170 name=__codelineno-1-170 href=#__codelineno-1-170></a>
<a id=__codelineno-1-171 name=__codelineno-1-171 href=#__codelineno-1-171></a><span class=go>--------------------------------------------------------------------------------</span>
<a id=__codelineno-1-172 name=__codelineno-1-172 href=#__codelineno-1-172></a>
<a id=__codelineno-1-173 name=__codelineno-1-173 href=#__codelineno-1-173></a><span class=go>Next speaker: triage_agent</span>
<a id=__codelineno-1-174 name=__codelineno-1-174 href=#__codelineno-1-174></a>
<a id=__codelineno-1-175 name=__codelineno-1-175 href=#__codelineno-1-175></a><span class=go>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; USING AUTO REPLY...</span>
<a id=__codelineno-1-176 name=__codelineno-1-176 href=#__codelineno-1-176></a><span class=go>triage_agent (to chat_manager):</span>
<a id=__codelineno-1-177 name=__codelineno-1-177 href=#__codelineno-1-177></a>
<a id=__codelineno-1-178 name=__codelineno-1-178 href=#__codelineno-1-178></a><span class=gp># </span>Mathematical<span class=w> </span>Model<span class=w> </span><span class=k>for</span><span class=w> </span>Non-Stationary<span class=w> </span>Multi-Armed<span class=w> </span>Bandit<span class=w> </span>with<span class=w> </span>Hidden<span class=w> </span>Markov<span class=w> </span>Model
<a id=__codelineno-1-179 name=__codelineno-1-179 href=#__codelineno-1-179></a>
<a id=__codelineno-1-180 name=__codelineno-1-180 href=#__codelineno-1-180></a><span class=gp>#</span><span class=c1># Problem Formulation</span>
<a id=__codelineno-1-181 name=__codelineno-1-181 href=#__codelineno-1-181></a>
<a id=__codelineno-1-182 name=__codelineno-1-182 href=#__codelineno-1-182></a><span class=go>Let&#39;s consider a non-stationary multi-armed bandit problem with \(K\) arms. The environment evolves according to a hidden Markov model (HMM) with hidden states \(s_t \in \mathcal{S}\) at each time step \(t\). The reward distribution of each arm \(i\) at time \(t\) depends on the hidden state \(s_t\), denoted as \(p_i(r|s_t)\).</span>
<a id=__codelineno-1-183 name=__codelineno-1-183 href=#__codelineno-1-183></a>
<a id=__codelineno-1-184 name=__codelineno-1-184 href=#__codelineno-1-184></a><span class=gp>#</span><span class=c1>## Hidden Markov Model Specification</span>
<a id=__codelineno-1-185 name=__codelineno-1-185 href=#__codelineno-1-185></a><span class=go>- State transition matrix: \(P(s_{t+1}|s_t)\)</span>
<a id=__codelineno-1-186 name=__codelineno-1-186 href=#__codelineno-1-186></a><span class=go>- Initial state distribution: \(\pi_0(s)\)</span>
<a id=__codelineno-1-187 name=__codelineno-1-187 href=#__codelineno-1-187></a><span class=go>- Emission probabilities: \(p_i(r|s)\) for each arm \(i\) and state \(s\)</span>
<a id=__codelineno-1-188 name=__codelineno-1-188 href=#__codelineno-1-188></a>
<a id=__codelineno-1-189 name=__codelineno-1-189 href=#__codelineno-1-189></a><span class=gp>#</span><span class=c1># Proposed UCB Modification: HMM-UCB</span>
<a id=__codelineno-1-190 name=__codelineno-1-190 href=#__codelineno-1-190></a>
<a id=__codelineno-1-191 name=__codelineno-1-191 href=#__codelineno-1-191></a><span class=go>I propose a modification of the UCB algorithm that incorporates Bayesian inference of the hidden states and adaptive confidence bounds.</span>
<a id=__codelineno-1-192 name=__codelineno-1-192 href=#__codelineno-1-192></a>
<a id=__codelineno-1-193 name=__codelineno-1-193 href=#__codelineno-1-193></a><span class=gp>#</span><span class=c1>## State Inference Component</span>
<a id=__codelineno-1-194 name=__codelineno-1-194 href=#__codelineno-1-194></a>
<a id=__codelineno-1-195 name=__codelineno-1-195 href=#__codelineno-1-195></a><span class=go>At each time step \(t\), the algorithm maintains a belief state \(b_t(s)\), representing the probability of being in state \(s\) at time \(t\):</span>
<a id=__codelineno-1-196 name=__codelineno-1-196 href=#__codelineno-1-196></a>
<a id=__codelineno-1-197 name=__codelineno-1-197 href=#__codelineno-1-197></a><span class=go>\[</span>
<a id=__codelineno-1-198 name=__codelineno-1-198 href=#__codelineno-1-198></a><span class=go>b_t(s) = P(s_t = s | h_t)</span>
<a id=__codelineno-1-199 name=__codelineno-1-199 href=#__codelineno-1-199></a><span class=go>\]</span>
<a id=__codelineno-1-200 name=__codelineno-1-200 href=#__codelineno-1-200></a>
<a id=__codelineno-1-201 name=__codelineno-1-201 href=#__codelineno-1-201></a><span class=go>where \(h_t\) is the history of actions and rewards up to time \(t\).</span>
<a id=__codelineno-1-202 name=__codelineno-1-202 href=#__codelineno-1-202></a>
<a id=__codelineno-1-203 name=__codelineno-1-203 href=#__codelineno-1-203></a><span class=go>After observing a reward \(r_t\) from arm \(a_t\), we update the belief using Bayes&#39; rule:</span>
<a id=__codelineno-1-204 name=__codelineno-1-204 href=#__codelineno-1-204></a>
<a id=__codelineno-1-205 name=__codelineno-1-205 href=#__codelineno-1-205></a><span class=go>\[</span>
<a id=__codelineno-1-206 name=__codelineno-1-206 href=#__codelineno-1-206></a><span class=go>b_{t+1}(s&#39;) = \frac{\sum_{s \in \mathcal{S}} P(s&#39;|s)b_t(s)p_{a_t}(r_t|s&#39;)}{\sum_{s&#39; \in \mathcal{S}}\sum_{s \in \mathcal{S}} P(s&#39;|s)b_t(s)p_{a_t}(r_t|s&#39;)}</span>
<a id=__codelineno-1-207 name=__codelineno-1-207 href=#__codelineno-1-207></a><span class=go>\]</span>
<a id=__codelineno-1-208 name=__codelineno-1-208 href=#__codelineno-1-208></a>
<a id=__codelineno-1-209 name=__codelineno-1-209 href=#__codelineno-1-209></a><span class=gp>#</span><span class=c1>## Adaptive UCB Formula</span>
<a id=__codelineno-1-210 name=__codelineno-1-210 href=#__codelineno-1-210></a>
<a id=__codelineno-1-211 name=__codelineno-1-211 href=#__codelineno-1-211></a><span class=go>The proposed HMM-UCB selects arms according to:</span>
<a id=__codelineno-1-212 name=__codelineno-1-212 href=#__codelineno-1-212></a>
<a id=__codelineno-1-213 name=__codelineno-1-213 href=#__codelineno-1-213></a><span class=go>\[</span>
<a id=__codelineno-1-214 name=__codelineno-1-214 href=#__codelineno-1-214></a><span class=go>a_t = \arg\max_i \left[ \hat{\mu}_i(t) + \alpha \sqrt{\frac{\log(t)}{N_i(t)}} \cdot \sqrt{\mathcal{H}(b_t)} \right]</span>
<a id=__codelineno-1-215 name=__codelineno-1-215 href=#__codelineno-1-215></a><span class=go>\]</span>
<a id=__codelineno-1-216 name=__codelineno-1-216 href=#__codelineno-1-216></a>
<a id=__codelineno-1-217 name=__codelineno-1-217 href=#__codelineno-1-217></a><span class=go>where:</span>
<a id=__codelineno-1-218 name=__codelineno-1-218 href=#__codelineno-1-218></a><span class=go>- \(\hat{\mu}_i(t) = \sum_{s \in \mathcal{S}} b_t(s)\hat{\mu}_i(s,t)\) is the expected reward of arm \(i\) under the current belief state</span>
<a id=__codelineno-1-219 name=__codelineno-1-219 href=#__codelineno-1-219></a><span class=go>- \(\hat{\mu}_i(s,t)\) is the estimated mean reward of arm \(i\) in state \(s\)</span>
<a id=__codelineno-1-220 name=__codelineno-1-220 href=#__codelineno-1-220></a><span class=go>- \(N_i(t)\) is the number of times arm \(i\) has been selected up to time \(t\)</span>
<a id=__codelineno-1-221 name=__codelineno-1-221 href=#__codelineno-1-221></a><span class=go>- \(\alpha\) is an exploration parameter</span>
<a id=__codelineno-1-222 name=__codelineno-1-222 href=#__codelineno-1-222></a><span class=go>- \(\mathcal{H}(b_t) = -\sum_{s \in \mathcal{S}} b_t(s)\log b_t(s)\) is the entropy of the belief state</span>
<a id=__codelineno-1-223 name=__codelineno-1-223 href=#__codelineno-1-223></a>
<a id=__codelineno-1-224 name=__codelineno-1-224 href=#__codelineno-1-224></a><span class=gp>#</span><span class=c1>## State-Dependent Reward Estimates</span>
<a id=__codelineno-1-225 name=__codelineno-1-225 href=#__codelineno-1-225></a>
<a id=__codelineno-1-226 name=__codelineno-1-226 href=#__codelineno-1-226></a><span class=go>For each state \(s\) and arm \(i\), we maintain estimates:</span>
<a id=__codelineno-1-227 name=__codelineno-1-227 href=#__codelineno-1-227></a>
<a id=__codelineno-1-228 name=__codelineno-1-228 href=#__codelineno-1-228></a><span class=go>\[</span>
<a id=__codelineno-1-229 name=__codelineno-1-229 href=#__codelineno-1-229></a><span class=go>\hat{\mu}_i(s,t) = \frac{\sum_{\tau=1}^{t-1} r_{\tau} \cdot \mathbb{I}\{a_{\tau}=i\} \cdot b_{\tau}(s)}{\sum_{\tau=1}^{t-1} \mathbb{I}\{a_{\tau}=i\} \cdot b_{\tau}(s) + \epsilon}</span>
<a id=__codelineno-1-230 name=__codelineno-1-230 href=#__codelineno-1-230></a><span class=go>\]</span>
<a id=__codelineno-1-231 name=__codelineno-1-231 href=#__codelineno-1-231></a>
<a id=__codelineno-1-232 name=__codelineno-1-232 href=#__codelineno-1-232></a><span class=go>where \(\epsilon\) is a small constant to avoid division by zero.</span>
<a id=__codelineno-1-233 name=__codelineno-1-233 href=#__codelineno-1-233></a>
<a id=__codelineno-1-234 name=__codelineno-1-234 href=#__codelineno-1-234></a><span class=gp>#</span><span class=c1># Advantages Over Thompson Sampling with Sliding Window</span>
<a id=__codelineno-1-235 name=__codelineno-1-235 href=#__codelineno-1-235></a>
<a id=__codelineno-1-236 name=__codelineno-1-236 href=#__codelineno-1-236></a><span class=go>1. **Explicit Modeling of State Transitions**: Unlike sliding window approaches that implicitly assume recent data is more relevant, HMM-UCB explicitly models how the environment changes through the transition matrix \(P(s_{t+1}|s_t)\).</span>
<a id=__codelineno-1-237 name=__codelineno-1-237 href=#__codelineno-1-237></a>
<a id=__codelineno-1-238 name=__codelineno-1-238 href=#__codelineno-1-238></a><span class=go>2. **Adaptive Exploration**: The exploration term scales with the entropy of the belief state \(\mathcal{H}(b_t)\). When there is high uncertainty about the current state (high entropy), the algorithm increases exploration to gather more information. In contrast, Thompson Sampling with sliding window uses a fixed exploration strategy regardless of state uncertainty.</span>
<a id=__codelineno-1-239 name=__codelineno-1-239 href=#__codelineno-1-239></a>
<a id=__codelineno-1-240 name=__codelineno-1-240 href=#__codelineno-1-240></a><span class=go>3. **Efficient Use of Historical Data**: Thompson Sampling with sliding window discards data outside the window entirely. HMM-UCB utilizes all historical data but weights it according to the inferred state sequence, providing more statistically efficient estimates when transitions are infrequent.</span>
<a id=__codelineno-1-241 name=__codelineno-1-241 href=#__codelineno-1-241></a>
<a id=__codelineno-1-242 name=__codelineno-1-242 href=#__codelineno-1-242></a><span class=go>4. **Predictive Capability**: By leveraging the known transition dynamics, HMM-UCB can anticipate state changes before they occur. Sliding window approaches can only react to changes after they have happened and enough data has been collected.</span>
<a id=__codelineno-1-243 name=__codelineno-1-243 href=#__codelineno-1-243></a>
<a id=__codelineno-1-244 name=__codelineno-1-244 href=#__codelineno-1-244></a><span class=go>5. **Theoretical Guarantees**: The HMM-UCB approach has stronger theoretical regret bounds in environments where the number of state transitions is sublinear in the time horizon, as it efficiently identifies and tracks the hidden states.</span>
<a id=__codelineno-1-245 name=__codelineno-1-245 href=#__codelineno-1-245></a>
<a id=__codelineno-1-246 name=__codelineno-1-246 href=#__codelineno-1-246></a><span class=go>The key innovation in this approach is the incorporation of the belief state entropy into the exploration term, which adaptively increases exploration during periods of uncertainty about the environment&#39;s state, providing a principled way to balance exploration and exploitation in non-stationary environments governed by HMMs.</span>
<a id=__codelineno-1-247 name=__codelineno-1-247 href=#__codelineno-1-247></a>
<a id=__codelineno-1-248 name=__codelineno-1-248 href=#__codelineno-1-248></a><span class=go>--------------------------------------------------------------------------------</span>
<a id=__codelineno-1-249 name=__codelineno-1-249 href=#__codelineno-1-249></a>
<a id=__codelineno-1-250 name=__codelineno-1-250 href=#__codelineno-1-250></a><span class=go>Next speaker: user_proxy</span>
<a id=__codelineno-1-251 name=__codelineno-1-251 href=#__codelineno-1-251></a>
<a id=__codelineno-1-252 name=__codelineno-1-252 href=#__codelineno-1-252></a><span class=go>Replying as user_proxy. Provide feedback to chat_manager. Press enter to skip and use auto-reply, or type &#39;exit&#39; to end the conversation: exit</span>
<a id=__codelineno-1-253 name=__codelineno-1-253 href=#__codelineno-1-253></a>
<a id=__codelineno-1-254 name=__codelineno-1-254 href=#__codelineno-1-254></a><span class=go>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; TERMINATING RUN (9872e7e6-acd5-4883-a987-f444acb83326): User requested to end the conversation</span>
<a id=__codelineno-1-255 name=__codelineno-1-255 href=#__codelineno-1-255></a>
<a id=__codelineno-1-256 name=__codelineno-1-256 href=#__codelineno-1-256></a><span class=go>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; TERMINATING RUN (ae8ab05d-4cac-4bf5-9cdf-069e2b0c74d5): No reply generated</span>
<a id=__codelineno-1-257 name=__codelineno-1-257 href=#__codelineno-1-257></a>
<a id=__codelineno-1-258 name=__codelineno-1-258 href=#__codelineno-1-258></a><span class=go>===== SUMMARY =====</span>
<a id=__codelineno-1-259 name=__codelineno-1-259 href=#__codelineno-1-259></a>
<a id=__codelineno-1-260 name=__codelineno-1-260 href=#__codelineno-1-260></a><span class=gp># </span>Mathematical<span class=w> </span>Model<span class=w> </span><span class=k>for</span><span class=w> </span>Non-Stationary<span class=w> </span>Multi-Armed<span class=w> </span>Bandit<span class=w> </span>with<span class=w> </span>Hidden<span class=w> </span>Markov<span class=w> </span>Model
<a id=__codelineno-1-261 name=__codelineno-1-261 href=#__codelineno-1-261></a>
<a id=__codelineno-1-262 name=__codelineno-1-262 href=#__codelineno-1-262></a><span class=gp>#</span><span class=c1># Problem Formulation</span>
<a id=__codelineno-1-263 name=__codelineno-1-263 href=#__codelineno-1-263></a>
<a id=__codelineno-1-264 name=__codelineno-1-264 href=#__codelineno-1-264></a><span class=go>Let&#39;s consider a non-stationary multi-armed bandit problem with \(K\) arms. The environment evolves according to a hidden Markov model (HMM) with hidden states \(s_t \in \mathcal{S}\) at each time step \(t\). The reward distribution of each arm \(i\) at time \(t\) depends on the hidden state \(s_t\), denoted as \(p_i(r|s_t)\).</span>
<a id=__codelineno-1-265 name=__codelineno-1-265 href=#__codelineno-1-265></a>
<a id=__codelineno-1-266 name=__codelineno-1-266 href=#__codelineno-1-266></a><span class=gp>#</span><span class=c1>## Hidden Markov Model Specification</span>
<a id=__codelineno-1-267 name=__codelineno-1-267 href=#__codelineno-1-267></a><span class=go>- State transition matrix: \(P(s_{t+1}|s_t)\)</span>
<a id=__codelineno-1-268 name=__codelineno-1-268 href=#__codelineno-1-268></a><span class=go>- Initial state distribution: \(\pi_0(s)\)</span>
<a id=__codelineno-1-269 name=__codelineno-1-269 href=#__codelineno-1-269></a><span class=go>- Emission probabilities: \(p_i(r|s)\) for each arm \(i\) and state \(s\)</span>
<a id=__codelineno-1-270 name=__codelineno-1-270 href=#__codelineno-1-270></a>
<a id=__codelineno-1-271 name=__codelineno-1-271 href=#__codelineno-1-271></a><span class=gp>#</span><span class=c1># Proposed UCB Modification: HMM-UCB</span>
<a id=__codelineno-1-272 name=__codelineno-1-272 href=#__codelineno-1-272></a>
<a id=__codelineno-1-273 name=__codelineno-1-273 href=#__codelineno-1-273></a><span class=go>I propose a modification of the UCB algorithm that incorporates Bayesian inference of the hidden states and adaptive confidence bounds.</span>
<a id=__codelineno-1-274 name=__codelineno-1-274 href=#__codelineno-1-274></a>
<a id=__codelineno-1-275 name=__codelineno-1-275 href=#__codelineno-1-275></a><span class=gp>#</span><span class=c1>## State Inference Component</span>
<a id=__codelineno-1-276 name=__codelineno-1-276 href=#__codelineno-1-276></a>
<a id=__codelineno-1-277 name=__codelineno-1-277 href=#__codelineno-1-277></a><span class=go>At each time step \(t\), the algorithm maintains a belief state \(b_t(s)\), representing the probability of being in state \(s\) at time \(t\):</span>
<a id=__codelineno-1-278 name=__codelineno-1-278 href=#__codelineno-1-278></a>
<a id=__codelineno-1-279 name=__codelineno-1-279 href=#__codelineno-1-279></a><span class=go>\[</span>
<a id=__codelineno-1-280 name=__codelineno-1-280 href=#__codelineno-1-280></a><span class=go>b_t(s) = P(s_t = s | h_t)</span>
<a id=__codelineno-1-281 name=__codelineno-1-281 href=#__codelineno-1-281></a><span class=go>\]</span>
<a id=__codelineno-1-282 name=__codelineno-1-282 href=#__codelineno-1-282></a>
<a id=__codelineno-1-283 name=__codelineno-1-283 href=#__codelineno-1-283></a><span class=go>where \(h_t\) is the history of actions and rewards up to time \(t\).</span>
<a id=__codelineno-1-284 name=__codelineno-1-284 href=#__codelineno-1-284></a>
<a id=__codelineno-1-285 name=__codelineno-1-285 href=#__codelineno-1-285></a><span class=go>After observing a reward \(r_t\) from arm \(a_t\), we update the belief using Bayes&#39; rule:</span>
<a id=__codelineno-1-286 name=__codelineno-1-286 href=#__codelineno-1-286></a>
<a id=__codelineno-1-287 name=__codelineno-1-287 href=#__codelineno-1-287></a><span class=go>\[</span>
<a id=__codelineno-1-288 name=__codelineno-1-288 href=#__codelineno-1-288></a><span class=go>b_{t+1}(s&#39;) = \frac{\sum_{s \in \mathcal{S}} P(s&#39;|s)b_t(s)p_{a_t}(r_t|s&#39;)}{\sum_{s&#39; \in \mathcal{S}}\sum_{s \in \mathcal{S}} P(s&#39;|s)b_t(s)p_{a_t}(r_t|s&#39;)}</span>
<a id=__codelineno-1-289 name=__codelineno-1-289 href=#__codelineno-1-289></a><span class=go>\]</span>
<a id=__codelineno-1-290 name=__codelineno-1-290 href=#__codelineno-1-290></a>
<a id=__codelineno-1-291 name=__codelineno-1-291 href=#__codelineno-1-291></a><span class=gp>#</span><span class=c1>## Adaptive UCB Formula</span>
<a id=__codelineno-1-292 name=__codelineno-1-292 href=#__codelineno-1-292></a>
<a id=__codelineno-1-293 name=__codelineno-1-293 href=#__codelineno-1-293></a><span class=go>The proposed HMM-UCB selects arms according to:</span>
<a id=__codelineno-1-294 name=__codelineno-1-294 href=#__codelineno-1-294></a>
<a id=__codelineno-1-295 name=__codelineno-1-295 href=#__codelineno-1-295></a><span class=go>\[</span>
<a id=__codelineno-1-296 name=__codelineno-1-296 href=#__codelineno-1-296></a><span class=go>a_t = \arg\max_i \left[ \hat{\mu}_i(t) + \alpha \sqrt{\frac{\log(t)}{N_i(t)}} \cdot \sqrt{\mathcal{H}(b_t)} \right]</span>
<a id=__codelineno-1-297 name=__codelineno-1-297 href=#__codelineno-1-297></a><span class=go>\]</span>
<a id=__codelineno-1-298 name=__codelineno-1-298 href=#__codelineno-1-298></a>
<a id=__codelineno-1-299 name=__codelineno-1-299 href=#__codelineno-1-299></a><span class=go>where:</span>
<a id=__codelineno-1-300 name=__codelineno-1-300 href=#__codelineno-1-300></a><span class=go>- \(\hat{\mu}_i(t) = \sum_{s \in \mathcal{S}} b_t(s)\hat{\mu}_i(s,t)\) is the expected reward of arm \(i\) under the current belief state</span>
<a id=__codelineno-1-301 name=__codelineno-1-301 href=#__codelineno-1-301></a><span class=go>- \(\hat{\mu}_i(s,t)\) is the estimated mean reward of arm \(i\) in state \(s\)</span>
<a id=__codelineno-1-302 name=__codelineno-1-302 href=#__codelineno-1-302></a><span class=go>- \(N_i(t)\) is the number of times arm \(i\) has been selected up to time \(t\)</span>
<a id=__codelineno-1-303 name=__codelineno-1-303 href=#__codelineno-1-303></a><span class=go>- \(\alpha\) is an exploration parameter</span>
<a id=__codelineno-1-304 name=__codelineno-1-304 href=#__codelineno-1-304></a><span class=go>- \(\mathcal{H}(b_t) = -\sum_{s \in \mathcal{S}} b_t(s)\log b_t(s)\) is the entropy of the belief state</span>
<a id=__codelineno-1-305 name=__codelineno-1-305 href=#__codelineno-1-305></a>
<a id=__codelineno-1-306 name=__codelineno-1-306 href=#__codelineno-1-306></a><span class=gp>#</span><span class=c1>## State-Dependent Reward Estimates</span>
<a id=__codelineno-1-307 name=__codelineno-1-307 href=#__codelineno-1-307></a>
<a id=__codelineno-1-308 name=__codelineno-1-308 href=#__codelineno-1-308></a><span class=go>For each state \(s\) and arm \(i\), we maintain estimates:</span>
<a id=__codelineno-1-309 name=__codelineno-1-309 href=#__codelineno-1-309></a>
<a id=__codelineno-1-310 name=__codelineno-1-310 href=#__codelineno-1-310></a><span class=go>\[</span>
<a id=__codelineno-1-311 name=__codelineno-1-311 href=#__codelineno-1-311></a><span class=go>\hat{\mu}_i(s,t) = \frac{\sum_{\tau=1}^{t-1} r_{\tau} \cdot \mathbb{I}\{a_{\tau}=i\} \cdot b_{\tau}(s)}{\sum_{\tau=1}^{t-1} \mathbb{I}\{a_{\tau}=i\} \cdot b_{\tau}(s) + \epsilon}</span>
<a id=__codelineno-1-312 name=__codelineno-1-312 href=#__codelineno-1-312></a><span class=go>\]</span>
<a id=__codelineno-1-313 name=__codelineno-1-313 href=#__codelineno-1-313></a>
<a id=__codelineno-1-314 name=__codelineno-1-314 href=#__codelineno-1-314></a><span class=go>where \(\epsilon\) is a small constant to avoid division by zero.</span>
<a id=__codelineno-1-315 name=__codelineno-1-315 href=#__codelineno-1-315></a>
<a id=__codelineno-1-316 name=__codelineno-1-316 href=#__codelineno-1-316></a><span class=gp>#</span><span class=c1># Advantages Over Thompson Sampling with Sliding Window</span>
<a id=__codelineno-1-317 name=__codelineno-1-317 href=#__codelineno-1-317></a>
<a id=__codelineno-1-318 name=__codelineno-1-318 href=#__codelineno-1-318></a><span class=go>1. **Explicit Modeling of State Transitions**: Unlike sliding window approaches that implicitly assume recent data is more relevant, HMM-UCB explicitly models how the environment changes through the transition matrix \(P(s_{t+1}|s_t)\).</span>
<a id=__codelineno-1-319 name=__codelineno-1-319 href=#__codelineno-1-319></a>
<a id=__codelineno-1-320 name=__codelineno-1-320 href=#__codelineno-1-320></a><span class=go>2. **Adaptive Exploration**: The exploration term scales with the entropy of the belief state \(\mathcal{H}(b_t)\). When there is high uncertainty about the current state (high entropy), the algorithm increases exploration to gather more information. In contrast, Thompson Sampling with sliding window uses a fixed exploration strategy regardless of state uncertainty.</span>
<a id=__codelineno-1-321 name=__codelineno-1-321 href=#__codelineno-1-321></a>
<a id=__codelineno-1-322 name=__codelineno-1-322 href=#__codelineno-1-322></a><span class=go>3. **Efficient Use of Historical Data**: Thompson Sampling with sliding window discards data outside the window entirely. HMM-UCB utilizes all historical data but weights it according to the inferred state sequence, providing more statistically efficient estimates when transitions are infrequent.</span>
<a id=__codelineno-1-323 name=__codelineno-1-323 href=#__codelineno-1-323></a>
<a id=__codelineno-1-324 name=__codelineno-1-324 href=#__codelineno-1-324></a><span class=go>4. **Predictive Capability**: By leveraging the known transition dynamics, HMM-UCB can anticipate state changes before they occur. Sliding window approaches can only react to changes after they have happened and enough data has been collected.</span>
<a id=__codelineno-1-325 name=__codelineno-1-325 href=#__codelineno-1-325></a>
<a id=__codelineno-1-326 name=__codelineno-1-326 href=#__codelineno-1-326></a><span class=go>5. **Theoretical Guarantees**: The HMM-UCB approach has stronger theoretical regret bounds in environments where the number of state transitions is sublinear in the time horizon, as it efficiently identifies and tracks the hidden states.</span>
<a id=__codelineno-1-327 name=__codelineno-1-327 href=#__codelineno-1-327></a>
<a id=__codelineno-1-328 name=__codelineno-1-328 href=#__codelineno-1-328></a><span class=go>The key innovation in this approach is the incorporation of the belief state entropy into the exploration term, which adaptively increases exploration during periods of uncertainty about the environment&#39;s state, providing a principled way to balance exploration and exploitation in non-stationary environments governed by HMMs.</span>
<a id=__codelineno-1-329 name=__codelineno-1-329 href=#__codelineno-1-329></a>
<a id=__codelineno-1-330 name=__codelineno-1-330 href=#__codelineno-1-330></a><span class=go>===== FINAL CONTEXT VARIABLES =====</span>
<a id=__codelineno-1-331 name=__codelineno-1-331 href=#__codelineno-1-331></a>
<a id=__codelineno-1-332 name=__codelineno-1-332 href=#__codelineno-1-332></a><span class=go>{</span>
<a id=__codelineno-1-333 name=__codelineno-1-333 href=#__codelineno-1-333></a><span class=go>  &quot;basic_agent_confidence&quot;: 3,</span>
<a id=__codelineno-1-334 name=__codelineno-1-334 href=#__codelineno-1-334></a><span class=go>  &quot;intermediate_agent_confidence&quot;: 7,</span>
<a id=__codelineno-1-335 name=__codelineno-1-335 href=#__codelineno-1-335></a><span class=go>  &quot;advanced_agent_confidence&quot;: 9,</span>
<a id=__codelineno-1-336 name=__codelineno-1-336 href=#__codelineno-1-336></a><span class=go>  &quot;escalation_count&quot;: 2,</span>
<a id=__codelineno-1-337 name=__codelineno-1-337 href=#__codelineno-1-337></a><span class=go>  &quot;last_escalation_reason&quot;: &quot;The complexity of the mathematical modeling and the need for empirical validation in specific scenarios.&quot;,</span>
<a id=__codelineno-1-338 name=__codelineno-1-338 href=#__codelineno-1-338></a><span class=go>  &quot;last_escalating_agent&quot;: &quot;intermediate_agent&quot;,</span>
<a id=__codelineno-1-339 name=__codelineno-1-339 href=#__codelineno-1-339></a><span class=go>  &quot;current_question&quot;: &quot;Develop a mathematical model for optimizing the tradeoff between exploration and exploitation in reinforcement learning for a non-stationary multi-armed bandit problem where the reward distributions shift according to a hidden Markov model. Include the formal equations for the Upper Confidence Bound (UCB) algorithm modification you would propose, and explain how your approach addresses the non-stationarity challenge better than Thompson Sampling with a sliding window.&quot;</span>
<a id=__codelineno-1-340 name=__codelineno-1-340 href=#__codelineno-1-340></a><span class=go>}</span>
<a id=__codelineno-1-341 name=__codelineno-1-341 href=#__codelineno-1-341></a>
<a id=__codelineno-1-342 name=__codelineno-1-342 href=#__codelineno-1-342></a><span class=go>===== SPEAKER ORDER =====</span>
<a id=__codelineno-1-343 name=__codelineno-1-343 href=#__codelineno-1-343></a>
<a id=__codelineno-1-344 name=__codelineno-1-344 href=#__codelineno-1-344></a><span class=go>user_proxy</span>
<a id=__codelineno-1-345 name=__codelineno-1-345 href=#__codelineno-1-345></a><span class=go>triage_agent</span>
<a id=__codelineno-1-346 name=__codelineno-1-346 href=#__codelineno-1-346></a><span class=go>_Group_Tool_Executor</span>
<a id=__codelineno-1-347 name=__codelineno-1-347 href=#__codelineno-1-347></a><span class=go>basic_agent</span>
<a id=__codelineno-1-348 name=__codelineno-1-348 href=#__codelineno-1-348></a><span class=go>_Group_Tool_Executor</span>
<a id=__codelineno-1-349 name=__codelineno-1-349 href=#__codelineno-1-349></a><span class=go>intermediate_agent</span>
<a id=__codelineno-1-350 name=__codelineno-1-350 href=#__codelineno-1-350></a><span class=go>_Group_Tool_Executor</span>
<a id=__codelineno-1-351 name=__codelineno-1-351 href=#__codelineno-1-351></a><span class=go>advanced_agent</span>
<a id=__codelineno-1-352 name=__codelineno-1-352 href=#__codelineno-1-352></a><span class=go>_Group_Tool_Executor</span>
<a id=__codelineno-1-353 name=__codelineno-1-353 href=#__codelineno-1-353></a><span class=go>triage_agent</span>
</code></pre></div> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class=timeago datetime=2025-05-08T13:42:16+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2025-05-08</span> </span> </aside> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../context_aware_routing/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Context-Aware Routing"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Context-Aware Routing </div> </div> </a> <a href=../feedback_loop/ class="md-footer__link md-footer__link--next" aria-label="Next: Feedback Loop"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Feedback Loop </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> &copy; 2025 <a href=https://ag2.ai/ target=_blank rel=noopener>ag2</a> </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://discord.gg/pAbnFJrkgZ target=_blank rel=noopener title=discord.gg class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M524.531 69.836a1.5 1.5 0 0 0-.764-.7A485 485 0 0 0 404.081 32.03a1.82 1.82 0 0 0-1.923.91 338 338 0 0 0-14.9 30.6 447.9 447.9 0 0 0-134.426 0 310 310 0 0 0-15.135-30.6 1.89 1.89 0 0 0-1.924-.91 483.7 483.7 0 0 0-119.688 37.107 1.7 1.7 0 0 0-.788.676C39.068 183.651 18.186 294.69 28.43 404.354a2.02 2.02 0 0 0 .765 1.375 487.7 487.7 0 0 0 146.825 74.189 1.9 1.9 0 0 0 2.063-.676A348 348 0 0 0 208.12 430.4a1.86 1.86 0 0 0-1.019-2.588 321 321 0 0 1-45.868-21.853 1.885 1.885 0 0 1-.185-3.126 251 251 0 0 0 9.109-7.137 1.82 1.82 0 0 1 1.9-.256c96.229 43.917 200.41 43.917 295.5 0a1.81 1.81 0 0 1 1.924.233 235 235 0 0 0 9.132 7.16 1.884 1.884 0 0 1-.162 3.126 301.4 301.4 0 0 1-45.89 21.83 1.875 1.875 0 0 0-1 2.611 391 391 0 0 0 30.014 48.815 1.86 1.86 0 0 0 2.063.7A486 486 0 0 0 610.7 405.729a1.88 1.88 0 0 0 .765-1.352c12.264-126.783-20.532-236.912-86.934-334.541M222.491 337.58c-28.972 0-52.844-26.587-52.844-59.239s23.409-59.241 52.844-59.241c29.665 0 53.306 26.82 52.843 59.239 0 32.654-23.41 59.241-52.843 59.241m195.38 0c-28.971 0-52.843-26.587-52.843-59.239s23.409-59.241 52.843-59.241c29.667 0 53.307 26.82 52.844 59.239 0 32.654-23.177 59.241-52.844 59.241"/></svg> </a> <a href=https://github.com/ag2ai/ag2 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg> </a> <a href=https://x.com/ag2oss target=_blank rel=noopener title=x.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9zm-24.8 373.8h39.1L151.1 88h-42z"/></svg> </a> <a href=https://www.youtube.com/@ag2ai target=_blank rel=noopener title=www.youtube.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305m-317.51 213.508V175.185l142.739 81.205z"/></svg> </a> <a href=https://www.linkedin.com/company/ag2ai target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../../..", "features": ["search.suggest", "search.highlight", "navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "navigation.tracking", "navigation.prune", "navigation.top", "navigation.footer", "content.tabs.link", "content.code.copy", "content.code.annotate", "content.action.edit"], "search": "../../../../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script> <script src=../../../../../assets/javascripts/bundle.c8b220af.min.js></script> <script src=../../../../../js/timeago.min.js></script> <script src=../../../../../js/timeago_mkdocs_material.js></script> <script src=../../../../../javascripts/extra.js></script> <script id=init-glightbox>const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>